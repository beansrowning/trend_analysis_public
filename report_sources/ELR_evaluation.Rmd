---
title: "ELR_evaluation"
author: "Neale Batra"
date: "7/6/2021"
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    toc_collapse: FALSE
    number_sections: TRUE
    highlight: pygments
    theme: spacelab
    code_folding: hide
    <!-- df_print: paged -->
    css: !expr here::here('css', 'style.css')
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Preparation {.tabset}

## Packages

```{r}
pacman::p_load(here, rio, lubridate, janitor, tidyverse, flextable, 
               DiagrammeR,     # for flow diagrams
               networkD3)      # For alluvial/Sankey diagrams
```

## Import latest data

Manual selection of data, so as to not store these data in the public-facing repository.
```{r, message=F, warning=F}
ELR_raw <- rio::import(file.choose(), sheet = "Data Entry")

#ELR_raw <- rio::import(here::here("data", "ELR", "COVID19_hq_epi_level_risk_tracking_01-07-2021.xlsx"), sheet = "Data Entry")
```


## Data cleaning

```{r, message=F, warning=F}
ELR <- ELR_raw %>% 
     rename(
          week = assessment_week_begins,
          dynamics = dynamics_classification,
          context = context_classification,
          final = final_classification) %>% 
     mutate(week = linelist::guess_dates(week),
            dynamics = recode(dynamics,
                              "Very High" = "Very high"),
            dynamics = fct_relevel(
                 dynamics,
                 "Very high", "High", "Medium", "Low", "Minimum", "Unknown"),
            #dynamics = fct_explicit_na(dynamics),
            # dynamics = fct_recode(dynamics,
            #                       5 = "Very high",
            #                       4 = "High",
            #                       3 = "Medium",
            #                       2 = "Low",
            #                       1 = "Minimal",
            #                       0 = "(Missing)"),
            
            ##############
            context = recode(context,
                             "possible" = "Possible",
                             "present" = "Present"),

            context = fct_relevel(context,
                                   "Present",
                                   "Possible",
                                   "None",
                                   "Unknown")) %>% 
            #context = fct_explicit_na(context),
            # context = fct_recode(context,
            #      1 = "Present",
            #      0 = "Possible",
            #      0 = "None",
            #      0 = "Unknown",
            #      0 = "(Missing)"),

            ###############
            #final = fct_explicit_na(final)) %>% 
            #final = fct_relevel(final, "(Missing)", after = 6)) %>% 
            # final = fct_recode(final, 
            #      6 = "1 - Critical",
            #      5 = "2 - Very high",
            #      4 = "3 - High",
            #      3 = "4 - Medium",
            #      2 = "5 - Low",
            #      1 = "6 - Minimal",
            #      0 = "(Missing)")) 
     
     arrange(week) %>% 
     drop_na(week) 


levels(ELR$final)
tabyl(ELR$week)
tabyl(ELR, final, dynamics)
```


```{r}
# named vectors 
alert <- c("1 - Critical", "2 - Very high")
warning <- c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium")
```



The latest date in the dataset is `r max(ELR$week, na.rm = T)`. There are `r nrow(ELR)` records.  


# Global overview 

## Alluvial links between dynamics-context-final ELR classifications (all time)

```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



```{r}
# counts by hospital and age category

value1 = unique(ELR$week[[1]])
value2 = unique(ELR$week[[2]])

get_links <- function(value1, value2){
  ELR %>% 
    drop_na(week) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    filter(week %in% c(value1, value2)) %>% 
    select(week, country, final)
    
             
    
}


```











# Regional ELR trends {.tabset}  


```{r}
ELR_long <- ELR %>% 
  group_by(country) %>% 
  arrange(country, week) %>% 
  slice(1:3) %>% 
  mutate(alert = ifelse(final %in% alert, 1, 0),
         recent_alert_score = sum(alert, na.rm=T)) %>% 
  #select(week, country, final, alert, recent_alert_score) %>% 
  ungroup() %>% 
  select(week, country, who_region, recent_alert_score, dynamics, context, final) %>% 
  pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value")

```



## PAHO

```{r}
region <- "PAHO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## AFRO  


```{r}
region <- "AFRO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```




## EURO

```{r}
region <- "EURO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```


## EMRO  


```{r}
region <- "EMRO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```






## SEARO  


```{r}
region <- "SEARO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## WPRO  


```{r}
region <- "WPRO"
```

### Heat plot  

```{r, fig.height="200%"}
ELR_long %>%
     filter(metric == "final",
            who_region == region) %>% 
     ggplot()+
     geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) +
    scale_fill_brewer(direction = -1)+ 
    #scale_fill_manual(values = c("White", "Red",  "Yellow",))
     theme_minimal()+
    theme(
      legend.title = element_text(size=12, face="bold"),
      legend.text  = element_text(size=10, face="bold"),
      legend.key.height = grid::unit(1,"cm"),           # height of legend key
      legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key
      
      axis.text.x = element_text(size=12),              # axis text size
      axis.text.y = element_text(vjust=0.2),            # axis text alignment
      axis.ticks = element_line(size=0.4),               
      axis.title = element_text(size=12, face="bold"),  # axis title size and bold
      
      plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold
      plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic
      )+
      labs(title = "ELR classifications by week",
           y = "Country/territory/area",
           x = "Date",
           fill = "ELR final\nclassification")
      

```

### Lines/points  

```{r message = F}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```




# Internal consistency  


<!--   -->

<!-- ```{r} -->
<!-- consistency <- ELR %>%  -->
<!--      group_by(country) %>%  -->
<!--      arrange(country, week) %>%  -->
<!--      mutate( -->
<!--           final_lag_1 = lag(final), -->
<!--           final_lag_2 = lag(final, 2)) %>%  -->
<!--      select(country, week, final, final_lag_1, final_lag_2) %>%  -->
<!--      mutate(premonition = case_when( -->
<!--           (!final %in% alert) ~ "Irrelevant", -->
<!--           (final %in% alert) & (final_lag_1 %in% warning) ~ "Caught", -->
<!--           TRUE ~ "Missed")) -->


<!-- metrics <- consistency %>%  -->
<!--      group_by(week) %>%  -->
<!--      summarise( -->
<!--           records = n(), -->
<!--           alarming = sum(premonition != "Irrelevant"), -->
<!--           caught = sum(premonition == "Caught"), -->
<!--           missed = sum(premonition == "Missed"), -->
<!--           prop_caught = scales::percent(caught / alarming)) -->

<!-- missed_list <- consistency %>%  -->
<!--      group_by(week) %>%  -->
<!--      filter(premonition == "Missed") %>%  -->
<!--      summarise( -->
<!--           across(country, ~paste0(na.omit(.x), collapse = "; "))) -->

<!-- missed_table <- left_join(metrics, missed_list, by = "week") -->

<!-- ``` -->


<!-- ```{r} -->
<!-- missed_table %>%  -->
<!--   flextable::qflextable() %>%  -->
<!--   width(j=1, width = 3) %>%  -->
<!--   width(j=3, width = 1) %>%  -->
<!--   flextable::set_header_labels( -->
<!--       week = "Week",  -->
<!--       records = "Records", -->
<!--       alarming = "Critical\nor Very high", -->
<!--       caught = "Caught", -->
<!--       missed = "Missed", -->
<!--       prop_caught = "%\nCaught", -->
<!--       country = "Countries missed") %>%  -->
<!--   flextable::set_caption( -->
<!--   "ELR internal consistency", -->
<!--   autonum = NULL, -->
<!--   style = "Table Caption", -->
<!--   html_escape = TRUE -->
<!-- ) -->


<!-- ``` -->



We examine the proportion of countries in a given week that were "caught" by the ELR process prior to their becoming a hotspot. That is, for the week when a country was *first* classified as either `r alert`, were they listed in the previous two weeks as either `r warning`?  

```{r}
consistency <- ELR %>% 
     group_by(country) %>% 
     arrange(country, week) %>% 
     select(country, who_region, week, final) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
     # mutate(first_alert_day = first_alert,
     #        first_alert_day = fill(first_alert_day))
     mutate(final_lag1 = lag(final),
            final_lag2 = lag(final, 2)) %>% 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag2 %in% warning) ~ "not warned"))
```


```{r}
  
# table by week
# alarm = critical or very high

tabyl(consistency$premonition_lag1)
tabyl(consistency$premonition_lag2)


consistency_table <- consistency %>% 
  group_by(week) %>% 
  summarise(
    records = n(),
    alert_on_first_entry = sum(premonition_lag1 == "first entry alert", na.rm=T),   # not relevant as country alarmed in it's first week being recorded
    first_alarm = sum(first_alert == 1 & premonition_lag1 != "first entry alert", na.rm=T),  # first time country alarmed (not in it's first week)
    caught = sum(first_alert == 1 & premonition_lag1 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed = sum(first_alert == 1 & premonition_lag1 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught1 = scales::percent(caught / first_alarm),
    caught2 = sum(first_alert == 1 & premonition_lag2 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed2 = sum(first_alert == 1 & premonition_lag2 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught2 = scales::percent(caught2 / first_alarm)
    )

alarming_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned" | premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("alarming countries" = country)


missed_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("missed_countries" = country)


caught_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("caught_countries" = country)

  
combined_table <- consistency_table %>% 
  left_join(missed_list, by = "week") %>% 
  left_join(caught_list, by = "week") %>% 
  select(week, records, alert_on_first_entry, first_alarm, caught, missed, prop_caught1, missed_countries, caught_countries, everything())

```


```{r}
nice_table <- combined_table %>% 
  flextable::qflextable() %>% 
  width(j=1, width = 3) %>% 
  width(j=3, width = 1) %>% 
  flextable::set_header_labels(
      week = "Week", 
      records = "Records",
      
      alert_on_first_entry = "Crit/VHigh\non first entry",
      first_alarm = "First time\nCrit/VHigh",

      caught = "Detected\n(Med/High)",
      missed = "Missed",
      prop_caught1 = "% Detected",

      caught2 = "Detected\n(Med/High)",
      missed2 = "Missed",      
      prop_caught2 = "% Detected",

      missed_countries = "Countries missed",
      caught_countries = "Countries detected"
      ) %>%
  
  flextable::set_caption(
  "ELR internal consistency - proportion of new alarming countries that were detected in prior weeks",
  autonum = NULL,
  style = "Table Caption",
  html_escape = TRUE
  ) %>% 
  
  border_remove() %>% 
  theme_box() %>% 
  
  # colors
  bg(., j = 4, part = "body", bg = "green") %>% 

  
  bg(., j = 5:6, part = "body", bg = "grey") %>% 
  bg(., j = 7:9, part = "body", bg = "darkgrey") %>% 

  bg(., j = 10:11, part = "body", bg = "orange") %>% 
  bg(., j = 12, part = "body", bg = "darkorange") %>% 

  bg(., i = 1, j = 4:12, part = "body", bg = "black") %>% 
  bg(., i = 2:nrow(combined_table), j = 3, part = "body", bg = "black") %>% 

  
  add_header_row(
    top = TRUE,                # New header goes on top of existing header row
    values = c("",     
               "", 
               "",    
               "",
               "Week prior",
               "",             
               "",             
               "",
               "", 
               "Two weeks prior",
               "",
               "")) %>% 
  
  merge_at(i = 1, j = 5:9, part = "header") %>% # Horizontally merge columns  in new header row
  merge_at(i = 1, j = 10:12, part = "header") %>% # Horizontally merge columns  in new header row
  
  align(i = 1, part = "header", align = "center") %>% 

  border_remove() %>% 
  theme_box() 

nice_table

# save
save_as_image(nice_table, path = here::here("outputs", "ELR_outputs", str_glue("ELR_evaluation_{max(combined_table$week)}.png")))
  

```








# Global early-alert trajectories {.tabset}  


```{r, warning=F, message=F}
medium_data <- consistency %>% 
  group_by(country) %>%
  
  # Find first Medium classification in Country
  mutate(first_med = { final %in% "4 - Medium"} %>% { . * !duplicated(.) }) %>% 
  
  # Number weeks by relationship to first medium
  filter(sum(first_med, na.rm=T) > 0) %>% 
  mutate(day_first_med = as.numeric((week - week[first_med == 1])/ 7)) %>% 
  
  # Factor re-ordering of ELR classifications
  mutate(final = fct_explicit_na(final)) %>% 
  mutate(final = fct_relevel(final, c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal"))) %>% 
  mutate(final = fct_rev(final)) %>% 
  
  # Create columns that look ahead 5 weeks
  mutate(post_med_1 = lead(final, 1)) %>% 
  mutate(post_med_2 = lead(final, 2)) %>% 
  mutate(post_med_3 = lead(final, 3)) %>% 
  mutate(post_med_4 = lead(final, 4)) %>% 
  mutate(post_med_5 = lead(final, 5)) %>% 

 
   # Look ahead for Critical or Very High
  mutate(future_alert = case_when(
    first_med == 1 & 
      ((post_med_1[first_med == 1] %in% alert) ||
      (post_med_2[first_med == 1]  %in% alert) ||
      (post_med_3[first_med == 1] %in% alert) ||
      (post_med_4[first_med == 1] %in% alert) ||
      (post_med_5[first_med == 1] %in% alert)
      ) ~ "Future alert",
    TRUE ~ "Not")) %>% 
  
  mutate(future_alert_filled = case_when(
    ("Future alert" %in% future_alert) ~ "Future alert",
    TRUE ~ "Not")) %>% 
  mutate(future_alert_filled = fct_relevel(future_alert_filled, c("Not", "Future alert")))
    


levels(medium_data$future_alert_filled)
tabyl(medium_data$future_alert_filled)


medium_data %>% 
  filter(who_region != "t") %>% 
  #mutate(final = fct_explicit_na(final)) %>%
  ggplot() +
  geom_line(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.5, size = 1)+
  scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~who_region)+
  geom_vline(xintercept = 0)+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "none")+
  labs(x = "Days from first 'Medium' classification",
       y = "ELR classification",
       title = "Medium countries that were critical/very high within 5 weeks")



```





# ELR mapping  

The current ELR map

```{r}
pacman::p_load(whomapper)

```

```{r}
who_shp <- whomapper::pull_who_adm0()
```

```{r}
map_data <- who_shp$adm0 %>% 
  left_join(ELR %>% 
               filter(week == max(week, na.rm=T)) %>%
               #drop_na(final) %>% 
               select(iso3, dynamics, context, final),
             by = c("iso_3_code" = "iso3")) #%>% 
  #drop_na(final)
 
```

```{r}
ggplot()+
  #geom_sf_who_poly(data = who_shp$adm0, fill = who_map_col("no_data")) +
  geom_sf_who_poly(data = map_data, aes(fill = final)) +

   scale_fill_viridis_d(
     option = "plasma",
     direction = 1,
     na.value = "white",
     name = "COVID-19 ELR\nclassification"
     )+
  
   # scale_fill_brewer(palette = "Set3",
   #                   na.value = who_map_col("no_data"),
   #                   name = "WHO Region")+

  labs(title ="[INTERNAL USE ONLY] Weekly Epidemiological Level of Risk (ELR)",
       subtitle = glue::glue("Risk of experiencing high, uncontrolled transmission in the next few weeks\nas assessed by HQ on {format(max(ELR$week, na.rm=T)+ lubridate::days(2), '%d %b %Y')}")) +
  who_map_pipeline() 

who_map_save(here::here("outputs", "ELR_outputs", glue::glue("who_ELR_map_{max(ELR$week, na.rm=T)}.png")), dpi = 700)

```