---
title: "ELR_evaluation"
author: "Neale Batra"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    toc_collapse: FALSE
    number_sections: TRUE
    highlight: pygments
    theme: spacelab
    code_folding: hide
    <!-- df_print: paged -->
    css: !expr here::here('css', 'style.css')
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


This is a report that assesses the ELR (Epidemiological Level of Risk) process, as performed by the Analytics and Intel teams of the COVID-19 epi response pillar.  



# Preparation {.tabset}

## Packages

```{r}
pacman::p_load(here, rio, lubridate, janitor, tidyverse, flextable,
               cowplot, ggpubr, # for plots 
               DiagrammeR,     # for flow diagrams
               networkD3)      # For alluvial/Sankey diagrams
```

## Import latest data

Manual selection of data, so as to not store these data in the public-facing repository.
```{r, message=F, warning=F}
ELR_raw <- rio::import(file.choose(), sheet = "Data Entry")

#ELR_raw <- rio::import(here::here("data", "ELR", "COVID19_hq_epi_level_risk_tracking_01-07-2021.xlsx"), sheet = "Data Entry")
```


## Data cleaning

```{r, message=F, warning=F}
ELR_all <- ELR_raw %>% 
  filter(who_region != "t") %>% 
  
  rename(
    week = assessment_week_begins,
    dynamics = dynamics_classification,
    context = context_classification,
    final = final_classification) %>% 
  
  mutate(
    
    week = linelist::guess_dates(week),
    
    ############
    relative_incidence = case_when(
      str_detect(relative_incidence, "%") ~ as.numeric(str_replace(relative_incidence, "%", "")),
      TRUE                                ~ 100*as.numeric(relative_incidence)),
    
    relative_incidence = replace(
      relative_incidence,
      relative_incidence > 200, NA),
          
    #############
    algorithm_classification = recode(
      algorithm_classification,
      "Mid" = "Medium"),
    
    #############
    final_raw = final,
    
    final = case_when(
      is.na(growth_rate) & is.na(relative_incidence) & is.na(final) ~ "No Data",
      is.na(final) ~ "6 - Minimal/NA",
      final == "6 - Minimal" ~ "6 - Minimal/NA",
    TRUE ~ final),
    
    # final = recode(
    #   final, 
    #   "6 - Minimal" = "Minimal/NA"),
    # final = replace_na(final, "Minimal/NA"),
    
    
    #############
    dynamics = recode(
      dynamics, "Very High" = "Very high"),
    
    dynamics = fct_relevel(
      dynamics, "Very high", "High", "Medium", "Low", "Minimum", "Unknown"),
            
    #############
    context = recode(
      context,
      "possible" = "Possible",
      "present" = "Present"),

    context = fct_relevel(
      context,
      "Present",
      "Possible",
      "None",
      "Unknown")) %>% 

     arrange(week) %>% 
     drop_na(week) 



# Make ELR of more recent X weeks, for analysis
weeks_include <- 6

ELR <- ELR_all %>% filter(week > max(ELR_all$week, na.rm=T) - weeks(weeks_include))




# hist(ELR$relative_incidence)
#tabyl(ELR$final)
# tabyl(ELR$week)
# tabyl(ELR, final, dynamics)
```


```{r}
# named vectors 
alert <- c("1 - Critical", "2 - Very high")
warning <- c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium")
```


This analysis utilizes the last `r weeks_include` weeks of ELR data, from `r max(ELR$week, na.rm=T) - weeks(weeks_include)``

The latest date in the dataset is `r max(ELR$week, na.rm = T)`. There are `r nrow(ELR)` records.  



# Map of the most recent ELR classifications  


```{r}
pacman::p_load(whomapper)

```



```{r}
who_shp <- whomapper::pull_who_adm0()
```



```{r}
map_data <- who_shp$adm0 %>% 
  left_join(ELR %>% 
               filter(week == max(week, na.rm=T)) %>%
               #drop_na(final) %>% 
               select(iso3, dynamics, context, final),
             by = c("iso_3_code" = "iso3")) #%>% 
  #drop_na(final)
 
```



```{r include=FALSE}
ELR_map <- ggplot()+
  #geom_sf_who_poly(data = who_shp$adm0, fill = who_map_col("no_data")) +
  geom_sf_who_poly(data = map_data, aes(fill = final)) +

   scale_fill_viridis_d(
     option = "plasma",
     direction = 1,
     na.value = "white",
     name = "COVID-19 ELR\nclassification"
     )+
  
   # scale_fill_brewer(palette = "Set3",
   #                   na.value = who_map_col("no_data"),
   #                   name = "WHO Region")+

  labs(title ="[INTERNAL USE ONLY] Weekly Epidemiological Level of Risk (ELR)",
       subtitle = glue::glue("Risk of experiencing high, uncontrolled transmission in the next few weeks\nas assessed by HQ on {format(max(ELR$week, na.rm=T)+ lubridate::days(2), '%d %b %Y')}")) +
  who_map_pipeline()

who_map_save(here::here("outputs", "ELR_outputs", glue::glue("who_ELR_map_{max(ELR$week, na.rm=T)}.png")), dpi = 700)
```



```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(
  here::here("outputs", "ELR_outputs", glue::glue("who_ELR_map_{max(ELR$week, na.rm=T)}.png"))
  )
```








# ELR classification trends  

**All analyses below utilize the last `r weeks_include` weeks of ELR data, from `r max(ELR$week, na.rm=T) - weeks(weeks_include)``.**  


```{r}
ELR %>% 
  filter(final %in% c("1 - Critical", "2 - Very high", "3 - High")) %>% 
  count(week) %>% 
  
  ggplot()+
  geom_line(aes(x = week, y = n), size = 1)+
  geom_label(aes(x = week, y = n, label = n))+
  theme_minimal()+
  labs(title = "Number of countries classified as Critical, Very high, or High",
       subtitle = "(n=238 each week) Note: this impacts the workload of Intel team")

```



```{r}
ELR %>% 
  count(week, final) %>% 
  
  ggplot(aes(x = week, y = n, color = final))+
  geom_line(size = 1)+
  geom_point()+
  #geom_label(aes(x = week, y = n, label = n), size = 2)+
  scale_x_date(
    date_breaks = "2 weeks",
    date_labels = "%d\n%b"
  )+
  facet_wrap(~final, scales = "free_y")+
  theme_minimal()+
  labs(title = "Number of countries by ELR classification",
       caption = str_glue("Analysis of the last 8 weeks"))

```





# Trajectories over time  

The final ELR classification by country

```{r}
ELR_wide <- ELR %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)

alluvial_gg <- ggplot(as.data.frame(ELR_wide) %>% 
         mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))),
       aes(
         y = n,
         axis1 = `2021-06-14`,
         axis2 = `2021-06-21`,
         axis3 = `2021-06-28`,
         axis4 = `2021-07-05`,
         axis5 = `2021-07-12`,
         axis6 = `2021-07-19`))+
          #axis3 = #colnames(ELR_wide)[3],
          #axis4 = #colnames(ELR_wide)[4],
          #axis5 = #colnames(ELR_wide)[5],
          #axis6 = #colnames(ELR_wide)[6],
          #xis7 = colnames(ELR_wide)[7],
          #axis8 = colnames(ELR_wide)[8]
          
  geom_alluvium(aes(fill = `2021-07-19`), width = 1/8) +
  geom_stratum(width = 1/8, fill = "black", color = "grey") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  #scale_x_discrete(limits = c("Gender", "Dept"), expand = c(.05, .05)) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Title")


alluvial_gg
```





```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  #filter(who_region == "EURO") %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```






```{r}

# plotly attempt



```

# Metrics trends  

This plot shows trends in the growth rate and case incidence, by week and region.  

```{r, warning=F, message=F}
ELR %>% 
  ggplot()+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = who_region))+
  geom_vline(xintercept = 0)+
  facet_grid(who_region~week)

```




# Early detection  

We examine the proportion of countries in a given week that were detected by the ELR process prior to their becoming a hotspot. That is, for the week when a country was *first* classified as either `r alert`, were they listed in the previous two weeks as either:  `r warning` ?  


```{r}
consistency <- ELR %>% 
     group_by(country) %>% 
     arrange(country, week) %>% 
     select(country, who_region, week, final) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
     # mutate(first_alert_day = first_alert,
     #        first_alert_day = fill(first_alert_day))
     mutate(final_lag1 = lag(final),
            final_lag2 = lag(final, 2)) %>% 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag2 %in% warning) ~ "not warned"))
```


```{r, warning=F, message=F}
  
# table by week
# alarm = critical or very high
# 
# tabyl(consistency$premonition_lag1)
# tabyl(consistency$premonition_lag2)


consistency_table <- consistency %>% 
  group_by(week) %>% 
  summarise(
    records = n(),
    alert_on_first_entry = sum(premonition_lag1 == "first entry alert", na.rm=T),   # not relevant as country alarmed in it's first week being recorded
    first_alarm = sum(first_alert == 1 & premonition_lag1 != "first entry alert", na.rm=T),  # first time country alarmed (not in it's first week)
    caught = sum(first_alert == 1 & premonition_lag1 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed = sum(first_alert == 1 & premonition_lag1 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught1 = scales::percent(caught / first_alarm),
    caught2 = sum(first_alert == 1 & premonition_lag2 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed2 = sum(first_alert == 1 & premonition_lag2 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught2 = scales::percent(caught2 / first_alarm)
    )

alarming_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned" | premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("alarming countries" = country)


missed_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("missed_countries" = country)


caught_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("caught_countries" = country)

  
combined_table <- consistency_table %>% 
  left_join(missed_list, by = "week") %>% 
  left_join(caught_list, by = "week") %>% 
  select(week, records, alert_on_first_entry, first_alarm, caught, missed, prop_caught1, missed_countries, caught_countries, everything())

```


```{r, warning=F, message=F}
nice_table <- combined_table %>% 
  flextable::qflextable() %>% 
  width(j=1, width = 3) %>% 
  width(j=3, width = 1) %>% 
  flextable::set_header_labels(
      week = "Week", 
      records = "Records",
      
      alert_on_first_entry = "Crit/VHigh\non first entry",
      first_alarm = "First time\nCrit/VHigh",

      caught = "Detected\n(Med/High)",
      missed = "Missed",
      prop_caught1 = "% Detected",

      caught2 = "Detected\n(Med/High)",
      missed2 = "Missed",      
      prop_caught2 = "% Detected",

      missed_countries = "Countries missed",
      caught_countries = "Countries detected"
      ) %>%
  
  flextable::set_caption(
  "ELR internal consistency - proportion of new alarming countries that were detected in prior weeks",
  autonum = NULL,
  style = "Table Caption",
  html_escape = TRUE
  ) %>% 
  
  border_remove() %>% 
  theme_box() %>% 
  
  # colors
  bg(., j = 4, part = "body", bg = "green") %>% 

  
  bg(., j = 5:6, part = "body", bg = "grey") %>% 
  bg(., j = 7:9, part = "body", bg = "darkgrey") %>% 

  bg(., j = 10:11, part = "body", bg = "orange") %>% 
  bg(., j = 12, part = "body", bg = "darkorange") %>% 

  bg(., i = 1, j = 4:12, part = "body", bg = "black") %>% 
  bg(., i = 2:nrow(combined_table), j = 3, part = "body", bg = "black") %>% 

  
  add_header_row(
    top = TRUE,                # New header goes on top of existing header row
    values = c("",     
               "", 
               "",    
               "",
               "Week prior",
               "",             
               "",             
               "",
               "", 
               "Two weeks prior",
               "",
               "")) %>% 
  
  merge_at(i = 1, j = 5:9, part = "header") %>% # Horizontally merge columns  in new header row
  merge_at(i = 1, j = 10:12, part = "header") %>% # Horizontally merge columns  in new header row
  
  align(i = 1, part = "header", align = "center") %>% 

  border_remove() %>% 
  theme_box() 

# save
#save_as_image(nice_table, path = here::here("outputs", "ELR_outputs", str_glue("ELR_evaluation_{max(combined_table$week)}.png")))
  
nice_table


```



## Trajectories of "Missed" countries  

```{r}
missed <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>%
     pull(country)
```

The "missed" countries were: `r str_c(missed, sep = ", ")` 

Below, we explore their ELR trajectories:

```{r, message = F, warning=F}
# USE IF FIRST TIME RUNNING
#case_inc <- phifunc::pull_case_death_data()
#rio::export(case_inc, "C:/Users/Neale/Downloads/case_inc.rds")

# USE IF RUNNING OFTEN IN ONE DAY
case_inc <- rio::import("C:/Users/Neale/Downloads/case_inc.rds")
```


```{r, warning=F, message=F}
ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
       country %in% missed,
       value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)

```



```{r}
plot_elr_epi <- function(country_name = NULL){
  
elr_data <- ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(country == country_name) %>% 
     filter(value != "(Missing)")
  
    min_date_elr <- as.Date("2021-05-31")    #min(elr_data$week, na.rm=T)
    max_date_elr <- max(elr_data$week, na.rm=T)
     
elr <- ggplot(data = elr_data)+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
    scale_x_date(limits = c(min_date_elr, max_date_elr))+
    labs(y = "ELR classification",
         x = "")+
    theme_cowplot()
  

  epi <- case_inc %>% 
    filter(report_country == country_name,
           report_date_WHO <= max_date_elr+6,
           report_date_WHO >= min_date_elr) %>% 
    select(report_country, report_date_WHO, new_num_case) %>% 
    
    ggplot()+
    geom_line(aes(x = report_date_WHO, y = new_num_case), alpha = 0.3, fill = "blue")+
    scale_y_continuous(                # adjust y-axis
      position = "right")+             # move percent axis to the right
    labs(y = "Daily case incidence",
         x = "\nDate",
         title = str_glue("ELR & epicurve for {country_name}"))+
    theme_cowplot()+
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
  
  
  aligned_plots <- cowplot::align_plots(elr, epi, align="hv", axis="tblr")
  return(ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]]))
}

#plot_elr_epi(country_name = "Russian Federation")
```

When we compare the ELR trajectories to the epidemic curves, it becomes clear that some of these countries were not truly "missed" but rather ignored for some reason without any ELR classification prior to their case surge.  


```{r, warning=F, message=F}
map(missed, plot_elr_epi)

#map(missed_plots, plot)
```



```{r}
#ggpubr::ggarrange(plotlist = missed_plots, ncol = 1, nrow = length(missed_plots))
```


# Characteristics of ELR "Medium"  


```{r, warning=F, message=F}
medium_data <- consistency %>% 
  group_by(country) %>%
  
  # Find first Medium classification in Country
  mutate(first_med = { final %in% "4 - Medium"} %>% { . * !duplicated(.) }) %>% 
  
  # Number weeks by relationship to first medium
  filter(sum(first_med, na.rm=T) > 0) %>% 
  mutate(day_first_med = as.numeric((week - week[first_med == 1])/ 7)) %>% 
  
  # Factor re-ordering of ELR classifications
  mutate(final = fct_explicit_na(final)) %>% 
  mutate(final = fct_relevel(final, c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal"))) %>% 
  mutate(final = fct_rev(final)) %>% 
  
  # Create columns that look ahead 5 weeks
  mutate(post_med_1 = lead(final, 1)) %>% 
  mutate(post_med_2 = lead(final, 2)) %>% 
  mutate(post_med_3 = lead(final, 3)) %>% 
  mutate(post_med_4 = lead(final, 4)) %>% 
  mutate(post_med_5 = lead(final, 5)) %>% 

 
   # Look ahead for Critical or Very High
  mutate(future_alert = case_when(
    first_med == 1 & 
      ((post_med_1[first_med == 1] %in% alert) ||
      (post_med_2[first_med == 1]  %in% alert) ||
      (post_med_3[first_med == 1] %in% alert) ||
      (post_med_4[first_med == 1] %in% alert) ||
      (post_med_5[first_med == 1] %in% alert)
      ) ~ "Future alert",
    TRUE ~ "Not")) %>% 
  
  mutate(future_alert_filled = case_when(
    ("Future alert" %in% future_alert) ~ "Future alert",
    TRUE ~ "Not")) %>% 
  mutate(future_alert_filled = fct_relevel(future_alert_filled, c("Not", "Future alert")))
    
```


```{r, eval=F}
medium_data %>% 
  filter(who_region != "t") %>% 
  #mutate(final = fct_explicit_na(final)) %>%
  ggplot() +
  geom_line(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.5, size = 1)+
  scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~who_region)+
  geom_vline(xintercept = 0)+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "none")+
  labs(x = "Days from first 'Medium' classification",
       y = "ELR classification",
       title = "Medium countries that were critical/very high within 5 weeks")



```


This section examines the nature and trajectories of countries that are classified as ELR Medium.  



If we plot the epidemiological metrics of countries when they are first classified as "Medium", they tend to be either:  

* High incidence and low growth (chronic - e.g. many countries in South America), or  
* Low incidence and high growth (budding outbreaks)  

The plot below shows this dynamic, as most Medium countries are either in the upper-left, or the lower-right. 

```{r, message=F, warning=F}
points_data <- medium_data %>% 
  filter(first_med == 1) %>% 
  left_join(ELR %>% select(country, week,
                           growth_rate,
                           relative_incidence,
                           net_increases_asmodee),
            by = c("country", "week"))


ggplot(points_data) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = who_region), size = 2, alpha = 0.8)+
  scale_color_brewer(type = "qual")+
  geom_vline(xintercept = 0)+
  theme_grey()+
  labs(color = "WHO regional office",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'Medium'")


```


The next question is - what happens to these countries *after* they are first classified as "Medium"? Do they rise upward to Critical or Very High ELR classifications? Or do they stay lower, at Medium or below?  

The plot below depicts the ELR classification trajectories of countries before and after they are first classified as "Medium" (day 0 on the x-axis). Each tiny line is one country's ELR trajectory, and there is a smoothed large line. There are two distinct patterns:  

1) Countries that increase to Critical or Very High within a few weeks (red)  
2) Countries that remain at lower ELR levels (blue)  

```{r, eval=T, message=F, warning=F}
medium_data %>% 
  filter(who_region != "t") %>% 
  #mutate(final = fct_explicit_na(final)) %>%
  ggplot() +
  geom_jitter(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.5, size = 1)+
  geom_line(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.1, size = 0.3)+

  geom_smooth(aes(x = day_first_med, y = final, group = future_alert_filled, color = future_alert_filled), alpha = 0.5, size = 1)+
  scale_color_manual(values = c("blue", "red"), labels = c("No", "Yes"))+
  #facet_wrap(~who_region)+
  geom_vline(xintercept = 0)+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  #theme(legend.position = "none")+
  labs(x = "Days from first 'Medium' classification",
       y = "ELR classification",
       title = "Trajectories of Medium countries",
       subtitle = "Some countries increased to Critical/Very High, while others did not",
       caption = "Points represent ELR classifications before or after first Medium classification (Day 0).\nPoints are jittered for visibility. Smoothing uses all points independently.",
       color = "Increased to\nCritical or V High")



```



Circling back to that original points plot of the metrics of metrics when they are first classified as Medium...  

While some countries in both the upper-left and lower-right sectors did increase to Critical/Very High ELR within a few weeks  of being classified as Medium (the red points above), countries in the upper-left sector (with higher incidence and lower growth) seemed to be more likely to increase than countries in the lower-right sector.  

So we may want to pay special attention to Medium countries that have higher incidence, even if they have lower growth rates.  

```{r, message=F, warning=F}

points_data$alert = ifelse(points_data$future_alert=="Future alert", 1, 0)

ggplot(points_data, aes(growth_rate, relative_incidence, z=alert)) +
  stat_summary_hex(fun=mean, bins=15, alpha = 0.5) +
  scale_fill_gradient(low="blue", high="red", labels=scales::percent_format(), name="Binned %")+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert), alpha = 1.0)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("red", "blue"), breaks = c("Future alert", "Not"), labels = c("Increased", "No increase"))+
  theme_minimal()+
  labs(color = "Country data points",
       y = "% Historical Peak",
       x = "Growth rate",
       title = "Outcomes of countries classified as 'Medium'",
       subtitle = "Did their ELR classification increase soon to Critical/Very High?")

  

# 
# # home-made tiles
# tile_data <- medium_data %>% 
#   filter(first_med == 1) %>% 
#   left_join(ELR %>% select(country, week,
#                            growth_rate,
#                            relative_incidence,
#                            net_increases_asmodee),
#             by = c("country", "week")) %>% 
#   drop_na(relative_incidence, growth_rate) %>% 
#   mutate(gr = cut(growth_rate, breaks = seq(-0.1, 0.3, 0.02)),
#          hist_inc = cut(relative_incidence, breaks = seq(0, 300, 10))) %>% 
#   group_by(gr, hist_inc) %>% 
#   summarise(
#     n = n(),
#     n_alert = sum(future_alert == "Future alert", na.rm=T),
#     prop_alert = n_alert / n
#     )
# 
#   ggplot()+
#   geom_tile(data = tile_data,
#             aes(x = gr, y = hist_inc, fill = prop_alert))+
#   labs(fill = "Proportion that\naccelerate",
#          title = "Growth and incidence among Medium countries,\nby future trends")

```


One hypothesis could be that countries with smaller but faster-growing epidemics are increasing testing and so their growth rates are high. But their overall incidence is still relatively low.  











<!-- # Algorithm adjustments -->

<!-- Adjustments made by the Analytics team to the automated classifications, to arrive at the dynamics classification.   -->


<!-- ```{r} -->
<!-- # counts by automated and dynamics  -->
<!-- links <- ELR %>%  -->
<!--   drop_na(algorithm_classification, dynamics) %>%  -->
<!--   filter(algorithm_classification != "(Missing)", -->
<!--          dynamics != "(Missing)") %>%  -->
<!--   select(algorithm_classification, dynamics) %>% -->
<!--   count(algorithm_classification, dynamics) %>%  -->
<!--   rename(source = algorithm_classification,          # re-name -->
<!--          target = dynamics) -->

<!-- # The unique node names -->
<!-- nodes <- data.frame( -->
<!--   name=c(as.character(links$source), as.character(links$target)) %>%  -->
<!--     unique() -->
<!--   ) -->

<!-- # Create id numbers -->
<!-- links$IDsource <- match(links$source, nodes$name)-1  -->
<!-- links$IDtarget <- match(links$target, nodes$name)-1 -->

<!-- # plot -->
<!-- ###### -->
<!-- p <- sankeyNetwork(Links = links, -->
<!--                    Nodes = nodes, -->
<!--                    Source = "IDsource", -->
<!--                    Target = "IDtarget", -->
<!--                    Value = "n", -->
<!--                    NodeID = "name", -->
<!--                    units = "TWh", -->
<!--                    fontSize = 12, -->
<!--                    nodeWidth = 30, -->
<!--                    iterations = 0) -->
<!-- p -->



<!-- ``` -->




# Global overview 

## Alluvial links between dynamics-context-final ELR classifications (all time)

```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



```{r}
# counts by hospital and age category

value1 = unique(ELR$week[[1]])
value2 = unique(ELR$week[[2]])

get_links <- function(value1, value2){
  ELR %>% 
    drop_na(week) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    filter(week %in% c(value1, value2)) %>% 
    select(week, country, final)
    
             
    
}


```











# Regional ELR trends {.tabset}  


```{r}
ELR_long <- ELR %>% 
  group_by(country) %>% 
  arrange(country, week) %>% 
  slice(1:3) %>% 
  mutate(alert = ifelse(final %in% alert, 1, 0),
         recent_alert_score = sum(alert, na.rm=T)) %>% 
  #select(week, country, final, alert, recent_alert_score) %>% 
  ungroup() %>% 
  select(week, country, who_region, recent_alert_score, dynamics, context, final) %>% 
  pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value")

```



## PAHO

```{r}
region <- "PAHO"
```


### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```




```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## AFRO  


```{r}
region <- "AFRO"
```


### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```




## EURO

```{r}
region <- "EURO"
```

### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```


## EMRO  


```{r}
region <- "EMRO"
```


### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```






## SEARO  


```{r}
region <- "SEARO"
```


### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## WPRO  


```{r}
region <- "WPRO"
```

<!-- ### Heat plot   -->

<!-- ```{r, fig.height="200%"} -->
<!-- ELR_long %>% -->
<!--      filter(metric == "final", -->
<!--             who_region == region) %>%  -->
<!--      ggplot()+ -->
<!--      geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) + -->
<!--     scale_fill_brewer(direction = -1)+  -->
<!--     #scale_fill_manual(values = c("White", "Red",  "Yellow",)) -->
<!--      theme_minimal()+ -->
<!--     theme( -->
<!--       legend.title = element_text(size=12, face="bold"), -->
<!--       legend.text  = element_text(size=10, face="bold"), -->
<!--       legend.key.height = grid::unit(1,"cm"),           # height of legend key -->
<!--       legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key -->

<!--       axis.text.x = element_text(size=12),              # axis text size -->
<!--       axis.text.y = element_text(vjust=0.2),            # axis text alignment -->
<!--       axis.ticks = element_line(size=0.4),                -->
<!--       axis.title = element_text(size=12, face="bold"),  # axis title size and bold -->

<!--       plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold -->
<!--       plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic -->
<!--       )+ -->
<!--       labs(title = "ELR classifications by week", -->
<!--            y = "Country/territory/area", -->
<!--            x = "Date", -->
<!--            fill = "ELR final\nclassification") -->


<!-- ``` -->

### Lines/points  

```{r message = F, out.height="150%", out.width="150%"}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r}
library(alluvial)

ELR_wide <- ELR %>% 
  
  filter(who_region == region) %>% 
  
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))  
  
  # make alluvial plot
  ELR_wide %>% 
    select(-n) %>% 
    filter(8 != "No Data") %>% 
  alluvial(freq = ELR_wide$n,
           col = case_when(
             ELR_wide[[ncol(ELR_wide)-1]] == "Critical"   ~ "black",
             ELR_wide[[ncol(ELR_wide)-1]] == "Very high"  ~ "darkred",
             ELR_wide[[ncol(ELR_wide)-1]] == "High"       ~ "red",
             ELR_wide[[ncol(ELR_wide)-1]] == "Medium"     ~ "darkorange",
             ELR_wide[[ncol(ELR_wide)-1]] == "Low"        ~ "green",
             ELR_wide[[ncol(ELR_wide)-1]] == "Minimal" ~ "darkgreen",

             TRUE ~ "#D3D3D3"),
           axis_labels = colnames(ELR_wide)[1:ncol(ELR_wide)-1],
           cex = 0.7)

#ggsave(here("outputs", "ELR_outputs", "alluvial.png"))
  
```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



