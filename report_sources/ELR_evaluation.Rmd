---
title: "ELR_evaluation"
author: "Neale Batra"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    toc_collapse: FALSE
    number_sections: TRUE
    highlight: pygments
    theme: spacelab
    code_folding: hide
    <!-- df_print: paged -->
    css: !expr here::here('css', 'style.css')
params:
  interactive: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


This is a report that assesses the ELR (Epidemiological Level of Risk) process, as performed by the Analytics and Intel teams of the COVID-19 epi response pillar.  





# Preparation {.tabset}

## Packages

```{r}
pacman::p_load(here, rio, lubridate, janitor, tidyverse, flextable,
               cowplot, ggpubr, # for plots 
               DiagrammeR,     # for flow diagrams
               networkD3)      # For alluvial/Sankey diagrams
```

## Import latest data

Manual selection of data, so as to not store these data in the public-facing repository.

```{r, message=F, warning=F}

if (params$interactive) {

  ELR_raw <- rio::import(file.choose(), sheet = "Data Entry")

  } else {

  message("Not in interactive mode. No data selected")
    
}

```


## Data cleaning

```{r, message=F, warning=F}
ELR_all <- ELR_raw %>% 
  filter(who_region != "t") %>% 
  
  rename(
    week = assessment_week_begins,
    dynamics = dynamics_classification,
    context = context_classification,
    final = final_classification) %>% 
  
  mutate(
    
    week = linelist::guess_dates(week),
    
      ############
    relative_incidence = case_when(
      str_detect(relative_incidence, "%") ~ as.numeric(str_replace(relative_incidence, "%", "")),
      TRUE                                ~ 100*as.numeric(relative_incidence)),
    
    relative_incidence = replace(
      relative_incidence,
      relative_incidence > 200, NA),
          
    #############
    algorithm_classification = recode(
      algorithm_classification,
      "Mid" = "Medium"),
    
    
    #############
    dynamics = case_when(
      is.na(dynamics) & algorithm_classification == "NL" ~ "Minimal",
      TRUE ~ dynamics),
    
    dynamics = recode(
      dynamics, "Very High" = "Very high"),
    
    dynamics = fct_relevel(
      dynamics, "Very high", "High", "Medium", "Low", "Minimal", "Unknown", "Insufficient data (chronic)"),
            
    #############
    context = recode(
      context,
      "possible" = "Possible",
      "present" = "Present"),

    context = fct_relevel(
      context,
      "Present",
      "Possible",
      "None",
      "Unknown"),
    
    final = case_when(
      is.na(final) & is.na(context) & dynamics == "No Data" ~ "6 - Minimal/NA",
      is.na(final) & is.na(context) & dynamics == "Low" ~ "5 - Low",
      is.na(final) & is.na(context) & dynamics == "Medium" ~ "4 - Medium",
      is.na(final) & is.na(context) & dynamics == "Minimal" ~ "6 - Minimal",
      TRUE ~ final),
    
    final = na_if(final, "No Data")) %>% 
  
  #filter(week != as.Date("2021-08-02")) %>% 
  
  # Make numeric columns for dynamics and final classification
  mutate(dynamics_lvl = case_when(
    dynamics == "Very high" ~ 1,
    dynamics == "High" ~ 2,
    dynamics == "Medium" ~ 3,
    dynamics == "Low" ~ 4,
    dynamics == "Minimal" ~ 5,
    dynamics == "Unknown" ~ 6)) %>% 
  
  mutate(final_lvl = case_when(
    final == "1 - Critical" ~ 0,
    final == "2 - Very high" ~ 1,
    final == "3 - High" ~ 2,
    final == "4 - Medium" ~ 3,
    final == "5 - Low" ~ 4,
    final == "6 - Minimal" ~ 5,
    final == "Unknown" ~ 6)) %>% 

  # Make bumped up column
  mutate(bump_up = case_when(
    context == "Present" & dynamics_lvl != final_lvl ~ "Bumped",
    TRUE ~ "Not bumped")) %>% 
  
  
    # final = recode(
    #   final, 
    #   "6 - Minimal" = "Minimal/NA"),
    # final = replace_na(final, "Minimal/NA"),
    
    
     #filter(week <= as.Date("2021-07-19")) %>% 
     arrange(week) %>% 
     drop_na(week) 



# Make ELR of more recent X weeks, for analysis
weeks_include <- 6

ELR <- ELR_all %>% filter(week > max(ELR_all$week, na.rm=T) - weeks(weeks_include))




# hist(ELR$relative_incidence)
#tabyl(ELR$final)
# tabyl(ELR$week)
# tabyl(ELR, final, dynamics)
```


```{r}
# named vectors 
alert <- c("1 - Critical", "2 - Very high")
warning <- c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium")
```


This analysis utilizes the last `r weeks_include` weeks of ELR data, from `r max(ELR$week, na.rm=T) - weeks(weeks_include)``

The latest date in the dataset is `r max(ELR$week, na.rm = T)`. There are `r nrow(ELR)` records.  






# Global pin plot

Showing Critical, Very high, and high  

```{r, warning=F, message=F, fig.width=9, fig.height=6}
pin_data <- ELR %>% 
  filter(week == max(week, na.rm=T)) %>% 
  #filter(final %in% c("1 - Critical", "2 - Very high", "3 - High")) %>% 
  mutate(relative_incidence = relative_incidence /100) %>% 
  mutate(departures = case_when(
    net_increases_asmodee >= 3 ~ "Accelerating",
    TRUE ~ "Not accelerating")
    ) 
  
pin_plot <- function(data){
  if{ data == "all"
  }
  ggplot(
    data = data %>% filter(who_region == data),
    mapping = aes(
      x = growth_rate,
      y = relative_incidence,
      shape = bump_up
      ))+
  geom_vline(aes(xintercept = c(0.0)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  geom_hline(aes(yintercept = c(1.0)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  #geom_vline(aes(xintercept = c(0.05)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  #geom_hline(aes(yintercept = .40), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  #geom_hline(aes(yintercept = .80), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  
  geom_point(aes(color = final))+
  scale_shape_manual(
    labels = c("Present", "Possible/None"),
    values = c(
    "Bumped" = 17,
    "Not bumped" = 16),
    name = "Contextual\naggravating\nfactors")+
  scale_color_manual(
    values = c(
      "1 - Critical" = "Black",
      "2 - Very high" = "Red",
      "3 - High" = "Orange"))+
  gghighlight::gghighlight(
    final %in% c("1 - Critical", "2 - Very high", "3 - High"),
    use_direct_label = FALSE)+
  ggrepel::geom_text_repel(
    data = pin_data %>% 
      filter(final %in% c("1 - Critical", "2 - Very high", "3 - High")),
    aes(label = country, segment.alpha = 0.3),
    min.segment.length = 0,
    force = 20,
    max.overlaps = Inf,
    size = 2.5
    )+
  theme_minimal(base_size = 14)+
  theme(plot.caption = element_text(face = "italic", hjust = 0))+
  coord_cartesian(xlim = c(-0.2, max(pin_data$growth_rate, na.rm=T)))+
  scale_y_continuous(labels = scales::label_percent())+
  #scale_x_continuous(breaks = seq(min(ELR$growth_rate, na.rm=T), max(ELR$growth_rate, na.rm=T), .05))+
  labs(
    x = "Daily growth rate",
    y = "Case incidence\nas percent of country historical peak",
    title = str_glue("[INTERNAL] Epidemiological Level of Risk (ELR)"),
    subtitle = str_glue("Highest final classifications globally, for {format(max(pin_data$week, na.rm=T), '%d %B, %Y')}"),
    color = "ELR final\nclassification",
    caption = "Assessment by HQ C19 Analytics and Intel teams with verification by regional offices.\nELR levels Medium, Low, Minimal, and No data are in grey.\nELR aims to assess risk of deterioration into a situation of\nwidespread, uncontrolled COVID-19 transmission in the very near future (2-4 weeks)"
  )
}

ggsave(here::here("outputs", "ELR_outputs", str_glue("ELR_pin_plot_global_{max(pin_data$week, na.rm=T)}.png")),
       pin_plot,
       width = 9,
       height = 6)

pin_plot
```


## One per region  






## Medium plot  

```{r}
pin_data_med <- pin_data %>% 
  filter(final == "4 - Medium")
  
pin_plot_med <- ggplot(
    data = pin_data_med,
    mapping = aes(
      x = growth_rate,
      y = relative_incidence,
      shape = bump_up
      ))+
  geom_vline(aes(xintercept = c(0.0)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  geom_hline(aes(yintercept = c(1.0)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  
  #geom_vline(aes(xintercept = c(0.05)), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  #geom_hline(aes(yintercept = .40), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  #geom_hline(aes(yintercept = .80), linetype = "dotted", alpha = 1, color = "salmon", size = 1)+
  
  geom_point(aes(color = final))+
  scale_shape_manual(
    labels = c("Alert", "Watchlist"),
    values = c(
    "Alert" = 17,
    "Watchlist" = 16),
    name = "Intel alert")+
  # scale_color_manual(
  #   values = c(
  #     "1 - Critical" = "Black",
  #     "2 - Very high" = "Red",
  #     "3 - High" = "Orange"))+
  gghighlight::gghighlight(
    final %in% c("1 - Critical", "2 - Very high", "3 - High"),
    use_direct_label = FALSE)+
  ggrepel::geom_text_repel(
    data = pin_data_med,
    aes(label = country, segment.alpha = 0.3),
    min.segment.length = 0,
    force = 20,
    max.overlaps = Inf,
    size = 2.5
    )+
  theme_minimal(base_size = 14)+
  scale_y_continuous(labels = scales::label_percent())+
  #scale_x_continuous(breaks = seq(min(ELR$growth_rate, na.rm=T), max(ELR$growth_rate, na.rm=T), .05))+
  labs(
    x = "Daily growth rate",
    y = "Case incidence\nas percent of country historical peak",
    title = str_glue("[INTERNAL] ELR 'Mediums'\n{format(max(pin_data$week, na.rm=T), '%d %B, %Y')}"),
    color = "ELR final\nclassification",
    caption = "caption text here..."
  )

ggsave(here::here("outputs", "ELR_outputs", str_glue("ELR_pin_plot_{max(pin_data$week, na.rm=T)}.png")),
       pin_plot,
       width = 9,
       height = 6)

```


On a plot of the mediums - 

by buckets and alert



## By region 






# Map of the most recent ELR classifications  


```{r}
pacman::p_load(whomapper)

```



```{r}
who_shp <- whomapper::pull_who_adm0()
```



```{r}
map_data <- who_shp$adm0 %>% 
  left_join(ELR %>% 
              #filter(week == as.Date("2021-07-19")) %>%  
              filter(week == max(week, na.rm=T)) %>%
               #drop_na(final) %>% 
               select(week, iso3, dynamics, context, final),
             by = c("iso_3_code" = "iso3")) %>%
  mutate(final_raw = na_if(final, "No data"))
  #drop_na(final)
 
```



```{r include=FALSE, warning=F, message=F}
ELR_map <- ggplot()+
  #geom_sf_who_poly(data = who_shp$adm0, fill = who_map_col("no_data")) +
  geom_sf_who_poly(data = map_data, aes(fill = final)) +

   scale_fill_viridis_d(
     option = "plasma",
     direction = 1,
     na.value = "white",
     labels = whp_map_legend_labs,
     name = "COVID-19 ELR\nclassification"
     )+

  # scale_fill_brewer(palette = "Set3",
  #                   na.value = who_map_col("no_data"),
  #                   name = "WHO Region", 
  #                   labels = whp_map_legend_labs) +
  labs(title ="[INTERNAL USE ONLY] Weekly Epidemiological Level of Risk (ELR)",
       subtitle = glue::glue("Risk of experiencing high, uncontrolled transmission in the next few weeks\nas assessed by Geneva Analytics & Intel teams on {format(max(map_data$week, na.rm=T)+ lubridate::days(2), '%d %b %Y')}")) +
  who_map_pipeline(no_data_scale = FALSE)

who_map_save(here::here("outputs", "ELR_outputs", glue::glue("who_ELR_map_{max(map_data$week, na.rm=T)}.png")), dpi = 700)
```



```{r out.width = "100%", fig.align = "center", echo=F, warning=F, message=F}
knitr::include_graphics(
  here::here("outputs", "ELR_outputs", glue::glue("who_ELR_map_{max(map_data$week, na.rm=T)}.png"))
  )
```



# Table of the most recent ELR classifications

```{r, warning=F, message=F}

unknown_data_list <- ELR %>% 
  filter(week == max(ELR$week, na.rm=T)) %>% 
  filter(is.na(final)) %>% 
  pull(country)

unknown_data <- str_glue("Countries with unknown classification due to limited data:\n{paste0(na.omit(unknown_data_list), collapse = '; ')}")

library(flextable)

ELR_table <- ELR %>% 
  mutate(final_display = case_when(
    final == "1 - Critical" ~ "Critical",
    final == "2 - Very high" ~ "Very high",
    final == "3 - High" ~ "High",
    final == "4 - Medium" ~ "Medium")) %>% 
  mutate(final_display = fct_relevel(final_display, "Critical", "Very high", "High", "Medium")) %>% 
  filter(week == max(ELR$week, na.rm=T)) %>% 
  select(who_region, country, final_display) %>% 
  drop_na(final_display) %>% 
  filter(!final_display %in% c("6 - Minimal", "5 - Low")) %>% 
  group_by(who_region, final_display, .drop = F) %>% 
  summarise(
    n = n(),
    names = paste0(na.omit(country), collapse = "; ")) %>% 

  qflextable() %>% 
  
  set_header_labels(         # Rename the columns in original header row
      who_region = "WHO regional office", 
      final_display = "ELR classification",                  
      n = "Count",
      names = "List") %>% 
  theme_box() %>% 
  merge_at(i = 1:4, j = 1, part = "body") %>% 
  merge_at(i = 5:8, j = 1, part = "body") %>% 
  merge_at(i = 9:12, j = 1, part = "body") %>% 
  merge_at(i = 13:16, j = 1, part = "body") %>% 
  merge_at(i = 17:20, j = 1, part = "body") %>% 
  merge_at(i = 21:24, j = 1, part = "body") %>% 
  
  add_header_row(
    values = c(str_glue("[INTERNAL] Weekly Epidemiological Level of Risk (ELR) assessed by HQ on {format(max(map_data$week, na.rm=T)+ lubridate::days(2), '%d %b %Y')}\nRisk of experiencing high, uncontrolled transmission in the next few weeks.\n***Only the top four classifications shown.***"),
               "", "", "")) %>% 
  merge_at(i = 1, part = "header") %>% 
  bold(i = 1, bold = TRUE, part = "header") %>% 
  
  color(j = 2, i = c(1, 5, 9, 13, 17, 21), "white", part = "body") %>% 
  bg(j = 2, i = ~ final_display == "Critical", part = "body", bg = "black") %>% 
  bg(j = 2, i = ~ final_display == "Very high", part = "body", bg = "red3") %>% 
  bg(j = 2, i = ~ final_display == "High", part = "body", bg = "red") %>% 
  bg(j = 2, i = ~ final_display == "Medium", part = "body", bg = "darkorange") %>% 

  flextable::footnote(i = 1, j = 1:4, part = "header", value = as_paragraph(unknown_data))

  ELR_table
```

`
```{r, warning=F, message=F, include=F}
save_as_image(ELR_table, here("outputs", "ELR_outputs", str_glue("who_ELR_table_{max(map_data$week, na.rm=T)}.png")))
```










# ELR classification trends  

**All analyses below utilize the last `r weeks_include` weeks of ELR data, from `r max(ELR$week, na.rm=T) - weeks(weeks_include)`.**  


```{r, warning=F, message=F}
#############
ELR <- ELR %>% 
  mutate(

    final_raw = final,
    
    final = case_when(
      is.na(growth_rate) & is.na(relative_incidence) & is.na(final) ~ "No Data",
      is.na(final) ~ "6 - Minimal/NA",
      final == "6 - Minimal" ~ "6 - Minimal/NA",
    TRUE ~ final)) %>%
  
  mutate(final = fct_relevel(
      final, "1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal/NA", "Unknown", "No Data"))
    
```



```{r, warning=F, message=F}
ELR %>% 
  filter(final %in% c("1 - Critical", "2 - Very high", "3 - High")) %>% 
  count(week) %>% 
  
  ggplot()+
  geom_line(aes(x = week, y = n), size = 1)+
  geom_label(aes(x = week, y = n, label = n))+
  theme_minimal()+
  labs(title = "Number of countries with final ELR classification Critical, Very high, or High",
       subtitle = "")

```



```{r}
ELR %>% 
  count(week, final) %>% 
  
  ggplot(aes(x = week, y = n, color = final))+
  geom_line(size = 1)+
  geom_point()+
  #geom_label(aes(x = week, y = n, label = n), size = 2)+
  scale_x_date(
    date_breaks = "weeks",
    date_labels = "%d\n%b"
  )+
  facet_wrap(~final,
             scales = "free_y"
             )+
  theme_minimal()+
  theme(legend.position = "none")+
  labs(title = "Number of countries by ELR classification",
       subtitle = "Note free y-axis scales",
       x = "Week",
       y = "Count of countries",
       caption = str_glue("Analysis of the last {weeks_include} weeks"))

```









# Trajectories over time  

The trajectory of country final ELR classifications over time. Each country's line is colored by its "current" ELR classification.  

Note: This global version can be difficult to read with all the countries - see regional-specific alluvial plots in their respective section below.  



```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 3) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = "[INTERNAL] ELR classification trajectories\ncolored by current classification (global)",
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")
```


This plot shows the opposite direction - the trajectory of country classifications from their "initial" classification 6 weeks ago.  

```{r, warning=F, message=F, fig.height=10, fig.width=10}
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = oldest_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 3) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = "[INTERNAL] ELR classification trajectories\nfrom earlest to current (global)",
    fill = str_glue("ELR classification\non {min(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```





# Intel component  

The Intel team performs in-depth context assessments of countries that are either:  

1) Highlighted by IBS or EBS activities, or
2) Classified by the analytics team as Very High, High, or Unknown  


```{r, warning=F, message=F}
# Make column for Intel-to-assess

ELR <- ELR %>% 
  mutate(intel_to_assess = case_when(
  `Highlighted during Validation` %in% c("Alert", "alert", "Watchlist") | 
  dynamics %in% c("Very high", "High", "Unknown") ~ "To assess",
  TRUE ~ "Not to assess"
  ))

```



```{r, warning=F, message=F}
ELR %>% 
  filter(intel_to_assess == "To assess") %>% 
  count(week) %>% 
  
  ggplot()+
  geom_line(aes(x = week, y = n), size = 1)+
  geom_label(aes(x = week, y = n, label = n))+
  theme_minimal()+
  labs(title = "Number of countries assessed by Intel team",
       subtitle = "Highlighted by IBS/EBS or dynamics classification Very high or High")


```





This table shows the percent of countries for which the final classification was the result of a *context assessment "bump"*, meaning:  

* The Intel team performed a context assessment on the country, and  
* The context assessment concluded that aggravating factors were present to accelerate the epidemic, and  
* The dynamics classification was consequently elevated "bumped" to one level higher  

The general conclusion is that many of the "Very high" classification are due to the Intel team's investigation.

Recall that "Critical" does not exist in the analytics team's dynamics classifications, and is only created when a country's dynamics are "Very high" and aggravating factors are "Present". Thus "Critical" = "Very High" + "Present". So all of Criticals should be created due to a "bump" (with rare exceptions).  



```{r, warning=F, message=F}
# Make column for Intel-to-assess

ELR %>% 
  group_by(week, final) %>% 
  summarise(
    n = n(),
    agg_factors_present = sum(context == "Present", na.rm=T),
    agg_factors_pct = scales::percent(agg_factors_present / n),
    bumped = sum(bump_up == "Bumped", na.rm=T),
    bumped_pct = scales::percent(bumped / n)) %>% 
  pivot_wider(id_cols = final, names_from = week, values_from = bumped_pct) %>% 
  flextable::qflextable()

```










# Regional trends - metrics  

This plot shows trends in the growth rate and case incidence, by week and region. Theoretically, one should be able to see shifts in each region if the behavior across countries is trending together, but it is currently difficult to see any trends.  


```{r, warning=F, message=F, fig.height=10, fig.width=10}
ELR %>% 
  ggplot()+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = who_region))+
  geom_vline(xintercept = 0)+
  facet_grid(who_region~week)

```




# Early detection  

We examine the proportion of countries in a given week that were detected by the ELR process prior to their becoming a hotspot. That is, for the week when a country was *first* classified as either `r alert`, were they listed in the previous two weeks as either:  `r warning` ?  

As a general interpretation: The ELR system is good at identifying countries one week prior to their becoming Critical/Vhigh, but not very good 2 weeks in advance. This aligns with the close analysis (below) of the "missed" countries, which shows very sudden accelerations.  


```{r}
consistency <- ELR_all %>% 
     group_by(country) %>% 
     arrange(country, week) %>% 
     select(week, country, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, final) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
     # mutate(first_alert_day = first_alert,
     #        first_alert_day = fill(first_alert_day))
     mutate(final_lag1 = lag(final),
            final_lag2 = lag(final, 2)) %>% 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag2 %in% warning) ~ "not warned"))
```


```{r, warning=F, message=F}
  
# table by week
# alarm = critical or very high
# 
# tabyl(consistency$premonition_lag1)
# tabyl(consistency$premonition_lag2)


consistency_table <- consistency %>% 
  group_by(week) %>% 
  summarise(
    records = n(),
    alert_on_first_entry = sum(premonition_lag1 == "first entry alert", na.rm=T),   # not relevant as country alarmed in it's first week being recorded
    first_alarm = sum(first_alert == 1 & premonition_lag1 != "first entry alert", na.rm=T),  # first time country alarmed (not in it's first week)
    caught = sum(first_alert == 1 & premonition_lag1 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed = sum(first_alert == 1 & premonition_lag1 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught1 = scales::percent(caught / first_alarm),
    caught2 = sum(first_alert == 1 & premonition_lag2 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed2 = sum(first_alert == 1 & premonition_lag2 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught2 = scales::percent(caught2 / first_alarm)
    )

alarming_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned" | premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("alarming countries" = country)


missed_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("missed_countries" = country)


caught_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("caught_countries" = country)

  
combined_table <- consistency_table %>% 
  left_join(missed_list, by = "week") %>% 
  left_join(caught_list, by = "week") %>% 
  select(week, records, alert_on_first_entry, first_alarm, caught, missed, prop_caught1, missed_countries, caught_countries, everything())

```


```{r, warning=F, message=F}
nice_table <- combined_table %>% 
  flextable::qflextable() %>% 
  width(j=1, width = 3) %>% 
  width(j=3, width = 1) %>% 
  flextable::set_header_labels(
      week = "Week", 
      records = "Records",
      
      alert_on_first_entry = "Crit/VHigh\non first entry",
      first_alarm = "First time\nCrit/VHigh",

      caught = "Detected\n(Med/High)",
      missed = "Missed",
      prop_caught1 = "% Detected",

      caught2 = "Detected\n(Med/High)",
      missed2 = "Missed",      
      prop_caught2 = "% Detected",

      missed_countries = "Countries missed",
      caught_countries = "Countries detected"
      ) %>%
  
  flextable::set_caption(
  "ELR internal consistency - proportion of new alarming countries that were detected in prior weeks",
  autonum = NULL,
  style = "Table Caption",
  html_escape = TRUE
  ) %>% 
  
  border_remove() %>% 
  theme_box() %>% 
  
  # colors
  bg(., j = 4, part = "body", bg = "green") %>% 

  
  bg(., j = 5:6, part = "body", bg = "grey") %>% 
  bg(., j = 7:9, part = "body", bg = "darkgrey") %>% 

  bg(., j = 10:11, part = "body", bg = "orange") %>% 
  bg(., j = 12, part = "body", bg = "darkorange") %>% 

  bg(., i = 1, j = 4:12, part = "body", bg = "black") %>% 
  bg(., i = 2:nrow(combined_table), j = 3, part = "body", bg = "black") %>% 

  
  add_header_row(
    top = TRUE,                # New header goes on top of existing header row
    values = c("",     
               "", 
               "",    
               "",
               "Week prior",
               "",             
               "",             
               "",
               "", 
               "Two weeks prior",
               "",
               "")) %>% 
  
  merge_at(i = 1, j = 5:9, part = "header") %>% # Horizontally merge columns  in new header row
  merge_at(i = 1, j = 10:12, part = "header") %>% # Horizontally merge columns  in new header row
  
  align(i = 1, part = "header", align = "center") %>% 

  border_remove() %>% 
  theme_box() 

# save
#save_as_image(nice_table, path = here::here("outputs", "ELR_outputs", str_glue("ELR_evaluation_{max(combined_table$week)}.png")))
  
nice_table


```



## Trajectories of "Missed" countries  

As described in the table above - the current definition of "missed" is that the country has been classified as "Critical" or "Very high", but was not classified as "Medium" or "High" in the previous week.  

Below we display the epicurve and ELR trajectories of each of these "missed" countries.   

```{r}
missed <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>%
     pull(country)
```

The "missed" countries were: `r str_c(missed, sep = ", ")` 

Below, we explore their ELR trajectories:

```{r, message = F, warning=F}
# USE IF FIRST TIME RUNNING
#case_inc <- phifunc::pull_case_death_data()
#rio::export(case_inc, "C:/Users/Neale/Downloads/case_inc.rds")

# USE IF RUNNING OFTEN IN ONE DAY
case_inc <- rio::import("C:/Users/Neale/Downloads/case_inc.rds")
```


```{r, warning=F, message=F}
ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
       country %in% missed,
       value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)

```



```{r}
plot_elr_epi <- function(country_name = NULL){
  
elr_data <- ELR_all %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(country == country_name) %>% 
     filter(value != "(Missing)")
  
    min_date_elr <- as.Date("2021-05-31")    #min(elr_data$week, na.rm=T)
    max_date_elr <- max(elr_data$week, na.rm=T)
     
elr <- ggplot(data = elr_data)+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
    scale_x_date(limits = c(min_date_elr, max_date_elr))+
    labs(y = "ELR classification",
         x = "")+
    theme_cowplot()
  

  epi <- case_inc %>% 
    filter(report_country == country_name,
           report_date_WHO <= max_date_elr+6,
           report_date_WHO >= min_date_elr) %>% 
    select(report_country, report_date_WHO, new_num_case) %>% 
    
    ggplot()+
    geom_line(aes(x = report_date_WHO, y = new_num_case), alpha = 0.3, fill = "blue")+
    scale_y_continuous(                # adjust y-axis
      position = "right")+             # move percent axis to the right
    labs(y = "Daily case incidence",
         x = "\nDate",
         title = str_glue("ELR & epicurve for {country_name}"))+
    theme_cowplot()+
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
  
  
  aligned_plots <- cowplot::align_plots(elr, epi, align="hv", axis="tblr")
  return(ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]]))
}

#plot_elr_epi(country_name = "Russian Federation")
```

When we compare the ELR trajectories to the epidemic curves, it becomes clear that some of these countries were not truly "missed" but rather ignored for some reason without any ELR classification prior to their case surge.  


```{r, warning=F, message=F}
map(missed, plot_elr_epi)
plot_elr_epi("Indonesia")
#map(missed_plots, plot)
```



```{r}
#ggpubr::ggarrange(plotlist = missed_plots, ncol = 1, nrow = length(missed_plots))
```






# Early detection  

We examine the proportion of countries in a given week that were detected by the ELR process prior to their becoming a hotspot. That is, for the week when a country was *first* classified as either `r alert`, were they listed in the previous two weeks as either:  `r warning` ?  

As a general interpretation: The ELR system is good at identifying countries one week prior to their becoming Critical/Vhigh, but not very good 2 weeks in advance. This aligns with the close analysis (below) of the "missed" countries, which shows very sudden accelerations.  


```{r}
consistency <- ELR_all %>% 
     group_by(country) %>% 
     arrange(country, week) %>% 
     select(week, country, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, final) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
     # mutate(first_alert_day = first_alert,
     #        first_alert_day = fill(first_alert_day))
     mutate(final_lag1 = lag(final),
            final_lag2 = lag(final, 2)) %>% 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag2 %in% warning) ~ "not warned"))
```


```{r, warning=F, message=F}
  
# table by week
# alarm = critical or very high
# 
# tabyl(consistency$premonition_lag1)
# tabyl(consistency$premonition_lag2)


consistency_table <- consistency %>% 
  group_by(week) %>% 
  summarise(
    records = n(),
    alert_on_first_entry = sum(premonition_lag1 == "first entry alert", na.rm=T),   # not relevant as country alarmed in it's first week being recorded
    first_alarm = sum(first_alert == 1 & premonition_lag1 != "first entry alert", na.rm=T),  # first time country alarmed (not in it's first week)
    caught = sum(first_alert == 1 & premonition_lag1 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed = sum(first_alert == 1 & premonition_lag1 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught1 = scales::percent(caught / first_alarm),
    caught2 = sum(first_alert == 1 & premonition_lag2 == "warned", na.rm=T),    # country's first alarm was preceeded lagged 1 week by Medium or higher
    missed2 = sum(first_alert == 1 & premonition_lag2 == "not warned", na.rm=T), # country's first alarm was preceeded lagged 2 weeks by Medium or higher
    prop_caught2 = scales::percent(caught2 / first_alarm)
    )

alarming_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned" | premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("alarming countries" = country)


missed_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "not warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("missed_countries" = country)


caught_list <- consistency %>% 
     group_by(week) %>% 
     filter(premonition_lag1 == "warned") %>% 
     summarise(
          across(country, ~paste0(na.omit(.x), collapse = "; "))) %>% 
  rename("caught_countries" = country)

  
combined_table <- consistency_table %>% 
  left_join(missed_list, by = "week") %>% 
  left_join(caught_list, by = "week") %>% 
  select(week, records, alert_on_first_entry, first_alarm, caught, missed, prop_caught1, missed_countries, caught_countries, everything())

```








# Characteristics of ELR "High"



```{r}

high_data <- consistency %>% 
  group_by(country) %>%
  
  # Find first Medium classification in Country
  mutate(first_high = { final %in% "3 - High"} %>% { . * !duplicated(.) }) %>% 
  
  # Number weeks by relationship to first medium
  filter(sum(first_high, na.rm=T) > 0) %>% 
  mutate(day_first_high = as.numeric((week - week[first_high == 1])/ 7)) %>% 
  
  # Factor re-ordering of ELR classifications
  mutate(final = fct_explicit_na(final)) %>% 
  mutate(final = fct_relevel(final, c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal"))) %>% 
  mutate(final = fct_rev(final)) %>% 
  
  # Create columns that look ahead 5 weeks
  mutate(post_high_1 = lead(final, 1)) %>% 
  mutate(post_high_2 = lead(final, 2)) %>% 
  mutate(post_high_3 = lead(final, 3)) %>% 
  mutate(post_high_4 = lead(final, 4)) %>% 
  mutate(post_high_5 = lead(final, 5)) %>% 

    # Create columns that look ahead 5 weeks
  mutate(pre_high_1 = lag(final, 1)) %>% 
  mutate(pre_high_2 = lag(final, 2)) %>% 
  mutate(pre_high_3 = lag(final, 3)) %>% 
  mutate(pre_high_4 = lag(final, 4)) %>% 
  mutate(pre_high_5 = lag(final, 5)) %>% 
  
  
  # identify countries on downward trajectory
  
    # Via ELR
    mutate(downward_elr = ((pre_high_1 %in% c(alert) | 
                              pre_high_2 %in% c(alert) | 
                              pre_high_3%in% c(alert) | 
                              pre_high_4 %in% c(alert) | 
                              pre_high_5 %in% c(alert)))) %>% 
    
    # # Via growth rate
    # mutate(downward_gr = case_when(
    #   first_med == 0 ~ NA_character_,
    #   first_med == 1 &
    #     growth_rate < 0 ~ "Downward",
    #   first_med == 1 & 
    #     growth_rate >= 0 ~ "Upward")) %>% 
  
  # classify highs into buckets
  mutate(high_class = case_when(
    
    # downward trajectory
    downward_elr == TRUE ~ "Downward",
    
    is.na(relative_incidence) &
      is.na(growth_rate) ~ "From no data",
    
    # High incidence, high growth
    relative_incidence >= 80 & 
      growth_rate >= 0.02 ~ "High, growing",
    
    # High incidence, low growth
    relative_incidence >= 80 &
      growth_rate < 0.02 ~ "High, stable",
    
    # Low incidence, high growth
    relative_incidence < 80 & 
      growth_rate >= 0.02 ~ "Emerging",
    
    # Low incidence, low growth
    relative_incidence < 80 & 
      growth_rate < 0.02 ~ "Low concern",
    
    # Other
    TRUE ~ "Other"
    
  )) %>% 
  
  group_by(country) %>% 
  
  # converts all rows in a country to value at first Medium
  mutate(high_class = high_class[first_high == 1]) %>% 
  
  ungroup(country) %>% 
  
  #filter(downward_gr == "Upward") %>% 
  #filter(all(downward_gr == "Downward")) %>% 
  
  select(
    country, week, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, high_class, first_high, day_first_high,
    pre_high_5, pre_high_4, pre_high_3, pre_high_2, pre_high_1,
    final,
    post_high_1, post_high_2, post_high_3, post_high_4, post_high_5) %>% 
 
  # Number of weeks to hit Critical / Very High  
  mutate(weeks_to_alarm = case_when(
      (post_high_1 %in% alert) ~ 1,
      (post_high_2 %in% alert) ~ 2,
      (post_high_3 %in% alert) ~ 3,
      (post_high_4 %in% alert) ~ 4, 
      (post_high_5 %in% alert) ~ 5)) %>% 
  
  group_by(country) %>% 
  filter(any(first_high == 1)) %>% 


  # Look ahead for Critical or Very High
  mutate(future_alert = case_when(
    first_high == 1 &
      ((post_high_1[first_high == 1] %in% alert) ||
      (post_high_2[first_high == 1]  %in% alert) ||
      (post_high_3[first_high == 1] %in% alert) ||
      (post_high_4[first_high == 1] %in% alert) ||
      (post_high_5[first_high == 1] %in% alert)
      ) ~ "Future alert",
    TRUE ~ "Not")) %>%

  mutate(future_alert_filled = case_when(
    ("Future alert" %in% future_alert) ~ "Future alert",
    TRUE ~ "Not")) %>%
  
  mutate(future_alert_filled = fct_relevel(future_alert_filled, c("Not", "Future alert"))) %>% 
  
  mutate(intel_bump = ifelse(final_lvl < dynamics_lvl, "Intelbump", "NoBump"))



```




```{r, eval=F}
high_data %>% 
  #filter(medium_class == "High, stable") %>% 
  ggplot() +
  geom_line(aes(x = day_first_high, y = final, group = country, color = country), alpha = 0.5, size = 1)+
  #scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~high_class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "none")+
  labs(x = "Weeks from first 'High' classification",
       y = "ELR classification",
       title = "High countries by class")



# Smoothed
high_data %>% 
  #filter(medium_class == "High, stable") %>% 
  ggplot() +
  geom_line(aes(x = day_first_high, y = final, group = country), color = "grey", alpha = 0.3, size = 1)+
  geom_smooth(aes(x = day_first_high, y = final, group = future_alert_filled, color = future_alert_filled))+
  scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~high_class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "bottom")+
  labs(x = "Weeks from first 'High' classification",
       y = "ELR classification",
       title = "Future trends in countries that hit 'high', by category")



```




So now we look at the epi metrics of these respective groups:  

```{r, warning=F, message=F}
ggplot(high_data %>% filter(first_high == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = high_class), size = 2, alpha = 0.8)+
  scale_color_brewer(type = "qual")+
  geom_vline(xintercept = 0)+
  theme_grey()+
  labs(color = "Categories",
       subtitle = "Countries metrics when they first hit High, by category",
       y = "% of historical peak",
       x = "Growth rate",
       title = "'High' categories")
```




Below, the same plot but colored by whether the country went on to alarm in the future. Not a clear pattern.

```{r, warning=F, message=F}
ggplot(high_data %>% filter(first_high == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert_filled), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("blue", "red"))+
  theme_grey()+
  labs(color = "Hit Crit/VHigh\nin future",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'High'")
```




# Combined  


```{r}
consistency <- ELR_all %>% 
     group_by(country) %>% 
     arrange(country, week) %>% 
     select(week, country, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, final) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
     # mutate(first_alert_day = first_alert,
     #        first_alert_day = fill(first_alert_day))
     mutate(final_lag1 = lag(final),
            final_lag2 = lag(final, 2)) %>% 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (final_lag2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!final_lag2 %in% warning) ~ "not warned"))
```


```{r}

df_high  <- ELR_all %>% 
  
  group_by(country) %>%
  
  arrange(country, week) %>% 
  select(week, country, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, final) %>% 
  
  # row number and first entry
  mutate(entry = row_number()) %>% 
  mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
  mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>%
  
  # Find first Medium classification in Country
  mutate(first = { final %in% "3 - High"} %>% { . * !duplicated(.) }) %>% 
  
  # Number weeks by relationship to first medium
  filter(sum(first, na.rm=T) > 0) %>% 
  mutate(day_first = as.numeric((week - week[first == 1])/ 7)) %>% 
  
  # Factor re-ordering of ELR classifications
  mutate(final = fct_explicit_na(final)) %>% 
  mutate(final = fct_relevel(final, c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal"))) %>% 
  mutate(final = fct_rev(final)) %>% 
  
  # Create columns that look ahead 5 weeks
  mutate(post_1 = lead(final, 1)) %>% 
  mutate(post_2 = lead(final, 2)) %>% 
  mutate(post_3 = lead(final, 3)) %>% 
  mutate(post_4 = lead(final, 4)) %>% 
  mutate(post_5 = lead(final, 5)) %>% 

    # Create columns that look ahead 5 weeks
  mutate(pre_1 = lag(final, 1)) %>% 
  mutate(pre_2 = lag(final, 2)) %>% 
  mutate(pre_3 = lag(final, 3)) %>% 
  mutate(pre_4 = lag(final, 4)) %>% 
  mutate(pre_5 = lag(final, 5)) %>% 
  
  
  # identify countries on downward trajectory
  
    # Via ELR
    mutate(downward_elr = ((pre_1 %in% c(alert) | 
                              pre_2 %in% c(alert) | 
                              pre_3%in% c(alert) | 
                              pre_4 %in% c(alert) | 
                              pre_5 %in% c(alert)))) %>% 
    
    # # Via growth rate
    # mutate(downward_gr = case_when(
    #   first_med == 0 ~ NA_character_,
    #   first_med == 1 &
    #     growth_rate < 0 ~ "Downward",
    #   first_med == 1 & 
    #     growth_rate >= 0 ~ "Upward")) %>% 
  
  # classify highs into buckets
  mutate(class_row = case_when(
    
    # downward trajectory
    downward_elr == TRUE ~ "Downward",
    
    is.na(relative_incidence) &
      is.na(growth_rate) ~ "From no data",
    
    # High incidence, high growth
    relative_incidence >= 80 & 
      growth_rate >= 0.02 ~ "High, growing",
    
    # High incidence, low growth
    relative_incidence >= 80 &
      growth_rate < 0.02 ~ "High, stable",
    
    # Low incidence, high growth
    relative_incidence < 80 & 
      growth_rate >= 0.02 ~ "Emerging",
    
    # Low incidence, low growth
    relative_incidence < 80 & 
      growth_rate < 0.02 ~ "Low concern",
    
    # Other
    TRUE ~ "Other"
    
  )) %>% 
  
  group_by(country) %>% 
  
  # converts all rows in a country to value at first Medium
  mutate(class = class_row[first == 1]) %>% 
  
  ungroup(country) %>% 
  
  #filter(downward_gr == "Upward") %>% 
  #filter(all(downward_gr == "Downward")) %>% 
  
  select(
    country, week, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, class_row, class, first, day_first,
    pre_5, pre_4, pre_3, pre_2, pre_1,
    final,
    post_1, post_2, post_3, post_4, post_5) %>% 
 
  # Number of weeks to hit Critical / Very High  
  mutate(weeks_to_alarm = case_when(
      (post_1 %in% alert) ~ 1,
      (post_2 %in% alert) ~ 2,
      (post_3 %in% alert) ~ 3,
      (post_4 %in% alert) ~ 4, 
      (post_5 %in% alert) ~ 5)) %>% 
  
  group_by(country) %>% 
  
  filter(any(first == 1)) %>% 

  # Look ahead for Critical or Very High
  mutate(future_alert = case_when(
    first == 1 &
      ((post_1[first == 1] %in% alert) ||
      (post_2[first == 1]  %in% alert) ||
      (post_3[first == 1] %in% alert) ||
      (post_4[first == 1] %in% alert) ||
      (post_5[first == 1] %in% alert)
      ) ~ "Future alert",
    TRUE ~ "Not")) %>%

  mutate(future_alert_filled = case_when(
    ("Future alert" %in% future_alert) ~ "Future alert",
    TRUE ~ "Not")) %>%
  
  #mutate(future_alert_filled = fct_relevel(future_alert_filled, c("Not", "Future alert"))) %>% 
  
  mutate(intel_bump = ifelse(final_lvl < dynamics_lvl, "Intelbump", "NoBump")) %>% 
  
  mutate(detected_1 = case_when(
      ((pre_1[first == 1] %in% "3 - High")) ~ "Detected",
      TRUE ~ "Not")) %>%
  
  mutate(detected_2 = case_when(
      ((pre_2[first == 1] %in% "3 - High")) ~ "Detected",
      TRUE ~ "Not")) %>%
  
  mutate(detected_3 = case_when(
      ((pre_3[first == 1] %in% "3 - High")) ~ "Detected",
      TRUE ~ "Not")) %>%

  mutate(criteria = "High") %>% 
  select(criteria, everything())




```


```{r}

df_medium  <- ELR_all %>% 
  group_by(country) %>%
  
  arrange(country, week) %>% 
  select(week, country, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, final) %>% 
  
  # row number and first entry
  mutate(entry = row_number()) %>% 
  mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
  mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>%
  
  # Find first Medium classification in Country
  mutate(first = { final %in% "4 - Medium"} %>% { . * !duplicated(.) }) %>% 
  
  # Number weeks by relationship to first medium
  filter(sum(first, na.rm=T) > 0) %>% 
  mutate(day_first = as.numeric((week - week[first == 1])/ 7)) %>% 
  
  # Factor re-ordering of ELR classifications
  mutate(final = fct_explicit_na(final)) %>% 
  mutate(final = fct_relevel(final, c("1 - Critical", "2 - Very high", "3 - High", "4 - Medium", "5 - Low", "6 - Minimal"))) %>% 
  mutate(final = fct_rev(final)) %>% 
  
  # Create columns that look ahead 5 weeks
  mutate(post_1 = lead(final, 1)) %>% 
  mutate(post_2 = lead(final, 2)) %>% 
  mutate(post_3 = lead(final, 3)) %>% 
  mutate(post_4 = lead(final, 4)) %>% 
  mutate(post_5 = lead(final, 5)) %>% 

    # Create columns that look ahead 5 weeks
  mutate(pre_1 = lag(final, 1)) %>% 
  mutate(pre_2 = lag(final, 2)) %>% 
  mutate(pre_3 = lag(final, 3)) %>% 
  mutate(pre_4 = lag(final, 4)) %>% 
  mutate(pre_5 = lag(final, 5)) %>% 
  
  
  # identify countries on downward trajectory
  
    # Via ELR
    mutate(downward_elr = ((pre_1 %in% c(alert) | 
                              pre_2 %in% c(alert) | 
                              pre_3%in% c(alert) | 
                              pre_4 %in% c(alert) | 
                              pre_5 %in% c(alert)))) %>% 
    
    # # Via growth rate
    # mutate(downward_gr = case_when(
    #   first_med == 0 ~ NA_character_,
    #   first_med == 1 &
    #     growth_rate < 0 ~ "Downward",
    #   first_med == 1 & 
    #     growth_rate >= 0 ~ "Upward")) %>% 
  
  # classify highs into buckets
  mutate(class_row = case_when(
    
    # downward trajectory
    downward_elr == TRUE ~ "Downward",
    
    is.na(relative_incidence) &
      is.na(growth_rate) ~ "From no data",
    
    # High incidence, high growth
    relative_incidence >= 80 & 
      growth_rate >= 0.02 ~ "High, growing",
    
    # High incidence, low growth
    relative_incidence >= 80 &
      growth_rate < 0.02 ~ "High, stable",
    
    # Low incidence, high growth
    relative_incidence < 80 & 
      growth_rate >= 0.02 ~ "Emerging",
    
    # Low incidence, low growth
    relative_incidence < 80 & 
      growth_rate < 0.02 ~ "Low concern",
    
    # Other
    TRUE ~ "Other"
    
  )) %>% 
  
  group_by(country) %>% 
  
  # converts all rows in a country to value at first Medium
  mutate(class = class_row[first == 1]) %>% 
  
  ungroup(country) %>% 
  
  #filter(downward_gr == "Upward") %>% 
  #filter(all(downward_gr == "Downward")) %>% 
  
  select(
    country, week, who_region, growth_rate, relative_incidence, net_increases_asmodee, dynamics_lvl, final_lvl, class_row, class, first, day_first,
    pre_5, pre_4, pre_3, pre_2, pre_1,
    final,
    post_1, post_2, post_3, post_4, post_5) %>% 
 
  # Number of weeks to hit Critical / Very High  
  mutate(weeks_to_alarm = case_when(
      (post_1 %in% alert) ~ 1,
      (post_2 %in% alert) ~ 2,
      (post_3 %in% alert) ~ 3,
      (post_4 %in% alert) ~ 4, 
      (post_5 %in% alert) ~ 5)) %>% 
  
  
  # was the country detected prior to alert?
  
  
  
  group_by(country) %>% 
  
  filter(any(first == 1)) %>% 

  # Look ahead for Critical or Very High
  mutate(future_alert = case_when(
    first == 1 &
      ((post_1[first == 1] %in% alert) ||
      (post_2[first == 1]  %in% alert) ||
      (post_3[first == 1] %in% alert) ||
      (post_4[first == 1] %in% alert) ||
      (post_5[first == 1] %in% alert)
      ) ~ "Future alert",
    TRUE ~ "Not")) %>%
  
  # Detection 1, 2, or 3 weeks prior to 
  mutate(detected_1 = case_when(
      ((pre_1[first == 1] %in% "4 - Medium")) ~ "Detected",
      TRUE ~ "Not")) %>%
  
  mutate(detected_2 = case_when(
      ((pre_2[first == 1] %in% "4 - Medium")) ~ "Detected",
      TRUE ~ "Not")) %>%
  
  mutate(detected_3 = case_when(
      ((pre_3[first == 1] %in% "4 - Medium")) ~ "Detected",
      TRUE ~ "Not")) %>%

  mutate(future_alert_filled = case_when(
    ("Future alert" %in% future_alert) ~ "Future alert",
    TRUE ~ "Not")) %>%
  
  #mutate(future_alert_filled = fct_relevel(future_alert_filled, c("Not", "Future alert"))) %>% 
  
  mutate(intel_bump = ifelse(final_lvl < dynamics_lvl, "Intelbump", "NoBump")) %>% 
  
  mutate(criteria = "Medium") %>% 
  select(criteria, everything())



```




## combine high and low data
```{r}

df <- df_high %>% 
  bind_rows(df_medium)

```



## Table by trend

This is a table of the "trends" of countries when they first are classified as either Medium or High.  
These classifications are based on the metrics (growth rate and incidence) of the countries at that moment in time.  
You can see that fewer countries are "emerging" when they first hit High.  



```{r}
df %>% 
  filter(first == 1) %>% 
  tabyl(class, criteria)
```



Table of detected when first hit Medium or High at certain weeks till alarm.

```{r}
df %>% 
  filter(
    first == 1,
    future_alert == "Future alert",
    !class %in% c("Downward", "Other", "From no data")) %>% 
  group_by(criteria, week) %>% 
  summarise(
    n_rows = n(),
    
    n_1wk = sum(weeks_to_alarm == 1, na.rm=T),
    n_2wk = sum(weeks_to_alarm == 2, na.rm=T),
    n_3wk = sum(weeks_to_alarm == 3, na.rm=T),
    
    pct_1wk = n_1wk / n_rows,
    pct_2wk = n_2wk / n_rows,
    pct_3wk = n_3wk / n_rows) %>% 
  
  mutate(
    n_rows_cum = cumsum(n_rows),
    n_1wk_cum = cumsum(n_1wk),
    pct_1wk_cum = n_1wk_cum / n_rows_cum
)
  
  mutate(cummean(pct_1wk))
  
  pivot_longer(cols = c(starts_with("n_"), starts_with("pct_")), names_to = "metric", values_to = "proportion") %>% 
  filter(str_detect(metric, "pct_")) %>% 
  
  ggplot(aes(x = week, y = proportion, color = metric))+
  geom_line()+
  facet_wrap(~criteria)
  
```





```{r}
tbl <- df %>% 
  group_by(country) %>% 
     arrange(country, week) %>% 
     mutate(entry = row_number()) %>% 
     mutate(first_alert = { final %in% alert } %>% { . * !duplicated(.) }) %>%
     mutate(first_row = ifelse(row_number() == 1, TRUE, FALSE)) %>% 
 
     ungroup() %>% 
     mutate(premonition_lag1 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (pre_1 %in% warning) ~ "warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!pre_1 %in% warning) ~ "not warned")) %>% 
  
  mutate(premonition_lag2 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (pre_2 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!pre_2 %in% warning) ~ "not warned")) %>% 
  
    mutate(premonition_lag3 = case_when(
       first_alert == 1 &
         first_row == TRUE ~ "first entry alert",
       
       first_alert == 1 & 
         first_row == FALSE &
         (pre_3 %in% warning) ~"warned",
       
       first_alert == 1 & 
         first_row == FALSE & 
         (!pre_3 %in% warning) ~ "not warned")) %>% 
  
  
  
  
  # summarise table
  filter(    
    first_alert == 1,
    first_row == FALSE,
    !class %in% c("Downward", "Other", "From no data")) %>%
  
  group_by(criteria, week) %>% 
  summarise(
    
    n_rows = n(),
    
    #n_1wk = sum(weeks_to_alarm == 1, na.rm=T),
    #n_2wk = sum(weeks_to_alarm == 2, na.rm=T),
    #n_3wk = sum(weeks_to_alarm == 3, na.rm=T),
    
    #pct_1wk = n_1wk / n_rows,
    #pct_2wk = n_2wk / n_rows,
    #pct_3wk = n_3wk / n_rows)
    
  )
  
  
  
  
```



So now we look at the epi metrics of these respective groups:  

```{r, warning=F, message=F}
ggplot(df_high %>% filter(first == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = class), size = 2, alpha = 0.8)+
  scale_color_brewer(type = "qual")+
  geom_vline(xintercept = 0)+
  theme_grey()+
  labs(color = "Categories",
       subtitle = "Countries metrics when they first hit High, by category",
       y = "% of historical peak",
       x = "Growth rate",
       title = "'High' categories")
```



Below, the same plot but colored by whether the country went on to alarm in the future. Not a clear pattern.

```{r, warning=F, message=F}
ggplot(df_high %>% filter(first == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert_filled), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("blue", "red"))+
  theme_grey()+
  labs(color = "Hit Crit/VHigh\nin future",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'High'")
```










We begin by classifying countries that hit "medium" by their characteristics, into one of five categories:  

1) **Downward** - countries that were on a downward trend when they first hit "Medium"  
2) **High, stable** - countries with high incidence (>80%) but low growth (<0.02)  
3) **High, growing** - countries with high incidence *and* high growth  
4) **Emerging** - countries with low incidence (<80%) but high growth (>0.02)  
5) **Low concern** - countries with low incidence *and* low growth  
6) **From no data** - countries that hit Medium after having no data (likely due to Intel classification)  



```{r, eval=F}
df_medium %>% 
  #filter(medium_class == "High, stable") %>% 
  ggplot() +
  geom_line(aes(x = day_first, y = final, group = country, color = country), alpha = 0.5, size = 1)+
  #scale_color_manual(values = c("blue", "red"))+
  facet_wrap(~class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "none")+
  labs(x = "Weeks from first 'Medium' classification",
       y = "ELR classification",
       title = "Medium countries by class")

```

Now we plot smoother averages among these lines, colored by whether the country *went on* to "alarm" by hitting Critical or Very High"  


```{r}
# Smoothed
df_medium %>% 
  #filter(medium_class == "High, stable") %>% 
  ggplot() +
  geom_line(aes(x = day_first, y = final, group = country), color = "grey", alpha = 0.3, size = 1)+
  geom_smooth(aes(x = day_first, y = final, group = future_alert_filled, color = future_alert_filled))+
  scale_color_manual(values = c("red", "blue"))+
  facet_wrap(~class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "bottom")+
  labs(x = "Weeks from first 'Medium' classification",
       y = "ELR classification",
       title = "Future trends in countries that hit 'Medium', by category")




# Smoothed
df_medium %>% 
  filter(class %in% c("Emerging", "Low concern")) %>% 
  ggplot() +
  geom_line(aes(x = day_first, y = final, group = country, color = future_alert_filled), alpha = 0.2, size = 1)+
  geom_smooth(aes(x = day_first, y = final, group = future_alert_filled, color = future_alert_filled))+
  scale_color_manual(values = c("red", "blue"), labels = c("Crit/V high", "Stable/Decline"))+
  scale_x_continuous(breaks = seq(-8,8,1))+
  #facet_wrap(~class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "right")+
  labs(x = "Weeks from first 'Medium' classification",
       y = "ELR classification",
       color = "Future trend",
       title = "[DRAFT] ELR trends among countries with emerging epidemics",
       subtitle = "What happened after a country was first classified as 'Medium'")


# Smoothed
df_high %>% 
  filter(class %in% c("Emerging", "Low concern")) %>% 
  ggplot() +
  geom_line(aes(x = day_first, y = final, group = country, color = future_alert_filled), alpha = 0.2, size = 1)+
  geom_smooth(aes(x = day_first, y = final, group = future_alert_filled, color = future_alert_filled))+
  scale_color_manual(values = c("red", "blue"), labels = c("Crit/V high", "Stable/Decline"))+
  scale_x_continuous(breaks = seq(-8,8,1))+
  #facet_wrap(~class)+
  geom_vline(xintercept = 0)+
  #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  theme(legend.position = "right")+
  labs(x = "Weeks from first 'High' classification",
       y = "ELR classification",
       color = "Future trend",
       title = "ELR trends among countries with emerging epidemics",
       subtitle = "What happened after a country was first classified as 'High'")



# 
# # Examine individually
# medium_data %>% 
#   filter(medium_class == "Low concern") %>% 
#   ggplot() +
#   #geom_line(aes(x = day_first_med, y = final, group = country, color = country), alpha = 0.5, size = 1)+
#   geom_smooth(aes(x = day_first_med, y = final, group = future_alert_filled, color = future_alert_filled))+
#   #scale_color_manual(values = c("blue", "red"))+
#   facet_wrap(~medium_class)+
#   geom_vline(xintercept = 0)+
#   #ggrepel::geom_text_repel(aes(x = day_first_med, y = final, label = country))+
#   #gghighlight::gghighlight(future_alert == "Future alert")+
#   theme_minimal()+
#   theme(legend.position = "none")+
#   labs(x = "Weeks from first 'Medium' classification",
#        y = "ELR classification",
#        title = "Medium countries by class")



# 
# 
# medium_data %>% 
#   #mutate(final = fct_explicit_na(final)) %>%
#   ggplot() +
#   geom_line(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.5, size = 1)+
#   scale_color_manual(values = c("blue", "red"))+
#   facet_wrap(~who_region)+
#   geom_vline(xintercept = 0)+
#   #gghighlight::gghighlight(future_alert == "Future alert")+
#   theme_minimal()+
#   theme(legend.position = "none")+
#   labs(x = "Weeks from first 'Medium' classification",
#        y = "ELR classification",
#        title = "Medium countries that were critical/very high within 5 weeks")



```

It will be important to understand the countries that were of **Low concern**, **emerging**, or which were **high,stable** that went on to alarm (the red lines).  


4, 5, 6 weeks ago, how many mediums were there, and where did they go, how long till rise?
what % ended up H, VH, Crit?
Is there anything different about those countries that differ?
Then repeat for high - predictive value of each level



So now we look at the epi metrics of these respective groups:  

```{r, warning=F, message=F}
ggplot(df_medium %>% filter(first == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = class), size = 2, alpha = 0.8)+
  scale_color_brewer(type = "qual")+
  geom_vline(xintercept = 0)+
  theme_grey()+
  labs(color = "Categories",
       subtitle = "Countries metrics when they first hit Medium, by category",
       y = "% of historical peak",
       x = "Growth rate",
       title = "'Medium' categories")
```



Below, the same plot but colored by whether the country went on to alarm in the future. Not a clear pattern.

```{r, warning=F, message=F}
ggplot(df_medium %>% filter(first == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert_filled), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("blue", "red"))+
  theme_grey()+
  labs(color = "Hit Crit/VHigh\nin future",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'Medium'")
```



```{r}
medium_model_data <- medium_data %>%
  filter(first_med == 1)

model <- glm(future_alert_filled ~ intel_bump, family = "binomial", data = medium_model_data)

model_clean <- model %>% 
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>%  ## get a tidy dataframe of estimates 
  mutate(across(where(is.numeric), round, digits = 2))          ## round 

```




Below, the same plot but colored by whether the country went on to alarm in the future. Not a clear pattern.

```{r, warning=F, message=F}
ggplot(medium_data %>% filter(first_med == 1,
                              medium_class == "Low concern")) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert_filled), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("blue", "red"))+
  theme_grey()+
  labs(color = "Hit Crit/VHigh\nin future",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'Medium'")
```





This section examines the nature and trajectories of countries that are classified as ELR Medium.  



If we plot the epidemiological metrics of countries when they are first classified as "Medium", they tend to be either:  

* High incidence and low growth (chronic - e.g. many countries in South America), or  
* Low incidence and high growth (budding outbreaks)  

The plot below shows this dynamic, as most Medium countries are either in the upper-left, or the lower-right. 

```{r, message=F, warning=F}
# points_data <- medium_data %>% 
#   filter(first_med == 1) %>% 
#   left_join(ELR %>% select(country, week,
#                            growth_rate,
#                            relative_incidence,
#                            net_increases_asmodee),
#             by = c("country", "week"))


ggplot(medium_data %>% filter(first_med == 1)) +
  geom_point(aes(x = growth_rate, y = relative_incidence, color = medium_class), size = 2, alpha = 0.8)+
  scale_color_brewer(type = "qual")+
  geom_vline(xintercept = 0)+
  theme_grey()+
  labs(color = "Trending",
       y = "% of historical peak",
       x = "Growth rate",
       title = "Country metrics when first classified as 'Medium'")



ggplot(medium_data %>%
         filter(first_med == 1,
                medium_class != "Downward") %>% 
         drop_na(weeks_to_alarm)
       )+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = medium_class), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  ggrepel::geom_text_repel(aes(x = growth_rate, y = relative_incidence, label = country, color = medium_class))+
  theme_grey()+
  labs(color = "Weeks to\nCrit/VHigh",
       y = "% of historical peak",
       x = "Growth rate",
       title = "'Medium' Countries - Epi metrics and weeks to Critical/VHigh ELR")




ggplot(medium_data %>%
         filter(first_med == 1,
                medium_class != "Downward") %>% 
         drop_na(weeks_to_alarm)
       )+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = as.factor(weeks_to_alarm)), size = 2, alpha = 0.8)+
  geom_vline(xintercept = 0)+
  ggrepel::geom_text_repel(aes(x = growth_rate, y = relative_incidence, label = country, color = as.factor(weeks_to_alarm)))+
  theme_grey()+
  labs(color = "Weeks to\nCrit/VHigh",
       y = "% of historical peak",
       x = "Growth rate",
       title = "'Medium' Countries - Epi metrics and weeks to Critical/VHigh ELR")

```


The next question is - what happens to these countries *after* they are first classified as "Medium"? Do they rise upward to Critical or Very High ELR classifications? Or do they stay lower, at Medium or below?  

The plot below depicts the ELR classification trajectories of countries before and after they are first classified as "Medium" (day 0 on the x-axis). Each tiny line is one country's ELR trajectory, and there is a smoothed large line. There are two distinct patterns:  

1) Countries that increase to Critical or Very High within a few weeks (red)  
2) Countries that remain at lower ELR levels (blue)  

```{r, eval=T, message=F, warning=F}
medium_data %>% 
  filter(who_region != "t") %>% 
  #mutate(final = fct_explicit_na(final)) %>%
  ggplot() +
  geom_jitter(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.5, size = 1)+
  geom_line(aes(x = day_first_med, y = final, group = country, color = future_alert_filled), alpha = 0.1, size = 0.3)+

  geom_smooth(aes(x = day_first_med, y = final, group = future_alert_filled, color = future_alert_filled), alpha = 0.5, size = 1)+
  scale_color_manual(values = c("blue", "red"), labels = c("No", "Yes"))+
  #facet_wrap(~who_region)+
  geom_vline(xintercept = 0)+
  #gghighlight::gghighlight(future_alert == "Future alert")+
  theme_minimal()+
  #theme(legend.position = "none")+
  labs(x = "Weeks from first 'Medium' classification",
       y = "ELR classification",
       title = "Trajectories of Medium countries",
       subtitle = "Some countries increased to Critical/Very High, while others did not",
       caption = "Points represent ELR classifications before or after first Medium classification (Day 0).\nPoints are jittered for visibility. Smoothing uses all points independently.",
       color = "Increased to\nCritical or V High")



```



Circling back to that original points plot of the metrics of metrics when they are first classified as Medium...  

While some countries in both the upper-left and lower-right sectors did increase to Critical/Very High ELR within a few weeks  of being classified as Medium (the red points above), countries in the upper-left sector (with higher incidence and lower growth) seemed to be more likely to increase than countries in the lower-right sector.  

So we may want to pay special attention to Medium countries that have higher incidence, even if they have lower growth rates.  

```{r, message=F, warning=F}

points_data$alert = ifelse(points_data$future_alert=="Future alert", 1, 0)

ggplot(points_data, aes(growth_rate, relative_incidence, z=alert)) +
  stat_summary_hex(fun=mean, bins=15, alpha = 0.5) +
  scale_fill_gradient(low="blue", high="red", labels=scales::percent_format(), name="Binned %")+
  geom_point(aes(x = growth_rate, y = relative_incidence, color = future_alert), alpha = 1.0)+
  geom_vline(xintercept = 0)+
  scale_color_manual(values = c("red", "blue"), breaks = c("Future alert", "Not"), labels = c("Increased", "No increase"))+
  theme_minimal()+
  labs(color = "Country data points",
       y = "% Historical Peak",
       x = "Growth rate",
       title = "Outcomes of countries classified as 'Medium'",
       subtitle = "Did their ELR classification increase soon to Critical/Very High?")

  

# 
# # home-made tiles
# tile_data <- medium_data %>% 
#   filter(first_med == 1) %>% 
#   left_join(ELR %>% select(country, week,
#                            growth_rate,
#                            relative_incidence,
#                            net_increases_asmodee),
#             by = c("country", "week")) %>% 
#   drop_na(relative_incidence, growth_rate) %>% 
#   mutate(gr = cut(growth_rate, breaks = seq(-0.1, 0.3, 0.02)),
#          hist_inc = cut(relative_incidence, breaks = seq(0, 300, 10))) %>% 
#   group_by(gr, hist_inc) %>% 
#   summarise(
#     n = n(),
#     n_alert = sum(future_alert == "Future alert", na.rm=T),
#     prop_alert = n_alert / n
#     )
# 
#   ggplot()+
#   geom_tile(data = tile_data,
#             aes(x = gr, y = hist_inc, fill = prop_alert))+
#   labs(fill = "Proportion that\naccelerate",
#          title = "Growth and incidence among Medium countries,\nby future trends")

```


One hypothesis could be that countries with smaller but faster-growing epidemics are increasing testing and so their growth rates are high. But their overall incidence is still relatively low.  











<!-- # Algorithm adjustments -->

<!-- Adjustments made by the Analytics team to the automated classifications, to arrive at the dynamics classification.   -->


<!-- ```{r} -->
<!-- # counts by automated and dynamics  -->
<!-- links <- ELR %>%  -->
<!--   drop_na(algorithm_classification, dynamics) %>%  -->
<!--   filter(algorithm_classification != "(Missing)", -->
<!--          dynamics != "(Missing)") %>%  -->
<!--   select(algorithm_classification, dynamics) %>% -->
<!--   count(algorithm_classification, dynamics) %>%  -->
<!--   rename(source = algorithm_classification,          # re-name -->
<!--          target = dynamics) -->

<!-- # The unique node names -->
<!-- nodes <- data.frame( -->
<!--   name=c(as.character(links$source), as.character(links$target)) %>%  -->
<!--     unique() -->
<!--   ) -->

<!-- # Create id numbers -->
<!-- links$IDsource <- match(links$source, nodes$name)-1  -->
<!-- links$IDtarget <- match(links$target, nodes$name)-1 -->

<!-- # plot -->
<!-- ###### -->
<!-- p <- sankeyNetwork(Links = links, -->
<!--                    Nodes = nodes, -->
<!--                    Source = "IDsource", -->
<!--                    Target = "IDtarget", -->
<!--                    Value = "n", -->
<!--                    NodeID = "name", -->
<!--                    units = "TWh", -->
<!--                    fontSize = 12, -->
<!--                    nodeWidth = 30, -->
<!--                    iterations = 0) -->
<!-- p -->



<!-- ``` -->




# Global overview 

## Alluvial links between dynamics-context-final ELR classifications (all time)

```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



```{r}
# counts by hospital and age category

value1 = unique(ELR$week[[1]])
value2 = unique(ELR$week[[2]])

get_links <- function(value1, value2){
  ELR %>% 
    drop_na(week) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    filter(week %in% c(value1, value2)) %>% 
    select(week, country, final)
    
             
    
}


```











# Regional ELR trends {.tabset}  


```{r}
ELR_long <- ELR %>% 
  group_by(country) %>% 
  arrange(country, week) %>% 
  slice(1:3) %>% 
  mutate(alert = ifelse(final %in% alert, 1, 0),
         recent_alert_score = sum(alert, na.rm=T)) %>% 
  #select(week, country, final, alert, recent_alert_score) %>% 
  ungroup() %>% 
  select(week, country, who_region, recent_alert_score, dynamics, context, final) %>% 
  pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value")

```



## PAHO

```{r}
region <- "PAHO"
```


### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```




```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## AFRO  


```{r}
region <- "AFRO"
```


### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```




## EURO

```{r}
region <- "EURO"
```

### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```


## EMRO  


```{r}
region <- "EMRO"
```


### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```



```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```






## SEARO  


```{r}
region <- "SEARO"
```


### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  


```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```


```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```


```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



## WPRO  


```{r}
region <- "WPRO"
```

<!-- ### Heat plot   -->

<!-- ```{r, fig.height="200%"} -->
<!-- ELR_long %>% -->
<!--      filter(metric == "final", -->
<!--             who_region == region) %>%  -->
<!--      ggplot()+ -->
<!--      geom_tile(aes(x = week, y = fct_reorder(country, recent_alert_score, "mean"), fill = value)) + -->
<!--     scale_fill_brewer(direction = -1)+  -->
<!--     #scale_fill_manual(values = c("White", "Red",  "Yellow",)) -->
<!--      theme_minimal()+ -->
<!--     theme( -->
<!--       legend.title = element_text(size=12, face="bold"), -->
<!--       legend.text  = element_text(size=10, face="bold"), -->
<!--       legend.key.height = grid::unit(1,"cm"),           # height of legend key -->
<!--       legend.key.width  = grid::unit(0.6,"cm"),         # width of legend key -->

<!--       axis.text.x = element_text(size=12),              # axis text size -->
<!--       axis.text.y = element_text(vjust=0.2),            # axis text alignment -->
<!--       axis.ticks = element_line(size=0.4),                -->
<!--       axis.title = element_text(size=12, face="bold"),  # axis title size and bold -->

<!--       plot.title = element_text(hjust=0,size=14,face="bold"),  # title right-aligned, large, bold -->
<!--       plot.caption = element_text(hjust = 0, face = "italic")  # caption right-aligned and italic -->
<!--       )+ -->
<!--       labs(title = "ELR classifications by week", -->
<!--            y = "Country/territory/area", -->
<!--            x = "Date", -->
<!--            fill = "ELR final\nclassification") -->


<!-- ``` -->

### Lines/points  

```{r message = F, fig.height=10, fig.width=10}
 ELR %>% 
     select(week, country, who_region, dynamics, context, final) %>% 
     pivot_longer(cols = c(dynamics, context, final), names_to = "metric", values_to = "value") %>% 
     filter(metric == "final") %>% 
     mutate(value = fct_rev(fct_drop(value))) %>% 
     filter(
          #country == "Mozambique",
          who_region == region,
          value != "(Missing)"
          ) %>% 
     ggplot()+
     geom_point(aes(x = week, y = value))+
     geom_line(aes(x = week, y = value, group = 1))+
     scale_y_discrete(drop = F)+
     facet_wrap(~country)
```


### Alluvial  

```{r, warning=F, message=F}
ELR_wide <- ELR %>% 
  filter(who_region == region) %>% 
  pivot_wider(
    id_cols = c(country, who_region),
    names_from = week,
    values_from = final) %>% 
  drop_na() %>% 
  group_by(across(contains("2021"))) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(across(.cols = -n, 
                .fns = ~recode(.x,
                              "1 - Critical" = "Critical",
                              "2 - Very high" = "Very high", 
                              "3 - High" = "High",
                              "4 - Medium" = "Medium",
                              "5 - Low" = "Low",
                              "6 - Minimal/NA" = "Minimal",
                              "No Data" = "No Data"))) %>% 
  mutate(across(.cols = -n,
                .fns = ~fct_relevel(.x, c(
                  "Critical",
                  "Very high", 
                  "High",
                  "Medium",
                  "Low",
                  "Minimal",
                  "No Data")))) %>% 
  mutate(across(.cols = -n,
                .fns = fct_rev))

#levels(ELR_wide$`2021-07-19`)


library(ggalluvial)
#is_alluvia_form(as.data.frame(ELR_wide), axes = 1:3, silent = TRUE)


ELR_long_alluvial_original <- to_lodes_form(data.frame(ELR_wide),
                              key = "date",
                              axes = 1:6) %>% 
  mutate(date = str_replace_all(date, "X2021.", "")) %>% 
  mutate(stratum = fct_relevel(stratum,
                                    c("Critical",
                                      "Very high", 
                                      "High",
                                      "Medium",
                                      "Low",
                                      "Minimal",
                                      "No Data")))

# add current ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial_original,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == max(date, na.rm=T)) %>% 
              rename(
                current_date = date,
                current_ELR = stratum),
            by = c("alluvium" )) 

# add earliest ELR classifications
ELR_long_alluvial <- left_join(
  ELR_long_alluvial,
  ELR_long_alluvial_original %>%
              select(-n) %>% 
              filter(date == min(date, na.rm=T)) %>% 
              rename(
                oldest_date = date,
                oldest_ELR = stratum),
            by = c("alluvium" )) 

```

```{r, warning=F, message=F, fig.height=10, fig.width=10}
# plot showing current classification
ggplot(data = ELR_long_alluvial,
       aes(x = date, stratum = stratum, alluvium = alluvium,
           y = n, label = stratum)) +
  geom_alluvium(aes(fill = current_ELR)) +
  geom_stratum() +
  geom_text(stat = "stratum", size = 4) +
  theme_minimal(base_size = 18) +
  theme(legend.position = "top")+
  scale_fill_manual(
    values = c(
      "Critical" = "black",
      "Very high" = "darkred",
      "High" = "red",
      "Medium" = "darkorange",
      "Low" = "darkgreen",
      "Minimal" = "green",
      "No Data" = "grey"))+
  labs(
    title = str_glue("[INTERNAL] ELR classification trajectories\ncolored by current classification ({region})"),
    fill = str_glue("ELR classification\non {max(ELR_long_alluvial$date, na.rm=T)}"),
    caption = "Last 6 weeks of data")

```



```{r}
# counts by hospital and age category
dyn_cont_links <- ELR %>% 
  filter(who_region == region) %>% 
  drop_na(dynamics, context, final) %>% 
  filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
  select(dynamics, context) %>%
  count(dynamics, context) %>% 
  rename(source = dynamics,          # re-name
         target = context)

cont_final_links <- ELR %>% 
    filter(who_region == region) %>% 
    drop_na(dynamics, context, final) %>% 
    filter(dynamics != "(Missing)",
         context != "(Missing)",
         final != "(Missing)") %>% 
    select(context, final) %>% 
    count(context, final) %>% 
    rename(source = context,       # re-name
           target = final)

# combine links
links <- bind_rows(dyn_cont_links, cont_final_links)

# The unique node names
nodes <- data.frame(
  name=c(as.character(links$source), as.character(links$target)) %>% 
    unique()
  )

# Create id numbers
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

# plot
######
p <- sankeyNetwork(Links = links,
                   Nodes = nodes,
                   Source = "IDsource",
                   Target = "IDtarget",
                   Value = "n",
                   NodeID = "name",
                   units = "TWh",
                   fontSize = 12,
                   nodeWidth = 30,
                   iterations = 0)
p

```



